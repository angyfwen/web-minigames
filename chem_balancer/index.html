<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chem Balancer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Titan+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-deep: #020617;        
            --glass-panel: rgba(15, 23, 42, 0.95);
            --glass-border: rgba(6, 182, 212, 0.4);
            --primary: #06b6d4; 
            --secondary: #8b5cf6; 
            --accent: #f43f5e; 
            --success: #10b981; 
            --gold: #f59e0b; 
            --text-main: #f8fafc;
        }

        /* --- THE NUCLEAR SCROLL FIX --- */
        html, body {
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            overflow: hidden; /* kill scrollbars */
            position: fixed; /* freeze the document */
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Fredoka', sans-serif;
            touch-action: none; /* stop browser handling gestures */
            user-select: none;
            -webkit-user-select: none;
            overscroll-behavior: none;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0l25.98 15v30L30 60 4.02 45V15z' fill-opacity='0.02' fill='%23ffffff' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* --- UI CONTAINER --- */
        .screen {
            display: none; 
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 10;
        }

        /* removed the transform animation to stop the glitch */
        .screen.active { 
            display: flex; 
            animation: simpleFade 0.3s ease; 
        }
        @keyframes simpleFade { from{opacity:0;} to{opacity:1;} }

        /* --- CARDS --- */
        .cyber-card {
            background: linear-gradient(145deg, rgba(15, 23, 42, 0.95), rgba(2, 6, 23, 0.98));
            border: 1px solid var(--primary);
            box-shadow: 0 0 60px rgba(6, 182, 212, 0.15);
            border-radius: 30px;
            padding: 3rem;
            text-align: center;
            max-width: 600px;
            width: 90%;
            display: flex; flex-direction: column; align-items: center;
        }

        .panel-card {
            background: var(--glass-panel);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 1.5rem;
            width: 95%; max-width: 850px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }

        /* --- GAME ELEMENTS --- */
        h1 { 
            font-family: 'Titan One', cursive; font-size: 4rem; 
            background: linear-gradient(to bottom, #fff, #cffafe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0; line-height: 1;
        }

        .reactor-core {
            width: 140px; height: 140px;
            border-radius: 50%; margin-bottom: 2rem;
            position: relative; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 80px rgba(6, 182, 212, 0.25);
        }
        .reactor-icon { font-size: 5rem; color: #fff; z-index: 2; }
        .orbit { position: absolute; width: 100%; height: 100%; border: 1px solid rgba(6, 182, 212, 0.6); border-radius: 50%; animation: spin 5s linear infinite; }
        @keyframes spin { from{transform: rotate(0deg);} to{transform: rotate(360deg);} }

        /* --- EQUATION AREA --- */
        .equation-area {
            background: rgba(0,0,0,0.4);
            border-radius: 15px; padding: 1rem; margin: 1rem 0;
            display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 0.5rem;
            border: 1px solid rgba(255,255,255,0.05); min-height: 120px;
        }
        .compound-wrapper {
            display: flex; flex-direction: column; align-items: center;
            background: rgba(255,255,255,0.03); padding: 5px; border-radius: 10px;
        }
        .chem-input {
            width: 50px; height: 50px;
            border-radius: 10px; border: 2px solid #334155;
            background: #1e293b; color: var(--primary);
            font-family: 'Titan One', cursive; font-size: 1.5rem;
            text-align: center; outline: none;
        }
        .chem-input:focus { border-color: var(--primary); }
        .comp-label { font-size: 1.5rem; color: #e2e8f0; margin-left: 5px; font-weight: bold; }

        .molecule-visuals {
            display: flex; justify-content: center; gap: 2px; margin-top: 5px;
            height: 20px; align-items: center; max-width: 80px; flex-wrap: wrap;
        }
        .atom-orb {
            width: 14px; height: 14px; border-radius: 50%;
            box-shadow: inset -1px -1px 3px rgba(0,0,0,0.5);
            display: inline-block;
        }

        /* --- FEEDBACK --- */
        .meter-container { width: 100%; height: 6px; background: #1e293b; border-radius: 10px; margin: 8px 0; overflow: hidden; }
        .meter-fill { height: 100%; background: var(--secondary); width: 0%; transition: width 0.5s ease; }
        
        .atom-grid { display: flex; justify-content: center; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
        .atom-card {
            background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; padding: 4px 10px; min-width: 70px;
        }
        .atom-card.match { border-color: var(--success); background: rgba(16, 185, 129, 0.1); }
        .atom-card.mismatch { border-color: var(--accent); background: rgba(244, 63, 94, 0.1); }

        /* --- BUTTONS --- */
        .btn {
            border: none; border-radius: 12px; padding: 0.8rem 1.5rem;
            font-family: 'Fredoka', sans-serif; font-weight: 700; cursor: pointer;
            display: inline-flex; align-items: center; gap: 8px; color: white;
            justify-content: center;
        }
        .btn-primary { background: var(--primary); color: #0f172a; }
        .btn-info { background: var(--secondary); }
        .btn-check { background: linear-gradient(to right, var(--secondary), #a78bfa); width: 100%; max-width: 250px; border-radius: 50px; font-size: 1.2rem; }
        .btn-icon { width: 40px; height: 40px; padding: 0; background: rgba(255,255,255,0.1); border-radius: 8px; }

        /* --- MODAL --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-box {
            background: #1e293b; border: 2px solid var(--success);
            padding: 2rem; border-radius: 20px; text-align: center;
            width: 90%; max-width: 350px;
        }

        /* --- MOBILE SPECIFIC FIXES --- */
        @media (max-width: 768px) {
            /* THIS IS THE 80% FIX */
            .screen {
                display: none; /* hidden by default */
            }
            
            .screen.active {
                display: flex;
                /* scaling the content down to 80% and centering it */
                transform: scale(0.85); 
                transform-origin: center center;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }

            /* preventing internal scrolling */
            .cyber-card, .panel-card {
                max-height: 100vh;
                overflow: hidden;
                margin: 0;
            }
            
            h1 { font-size: 3rem; }
            .reactor-core { width: 100px; height: 100px; margin-bottom: 1rem; }
            .reactor-icon { font-size: 3.5rem; }
            
            .game-header { margin-bottom: 0.5rem; }
            .btn-check { padding: 0.8rem; font-size: 1.1rem; }
            
            .chem-input { width: 40px; height: 40px; font-size: 1.2rem; }
            .comp-label { font-size: 1.2rem; }
            
            /* modal fix */
            .modal-box { transform: scale(0.9); }
        }
    </style>
</head>
<body>

    <div style="position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:0; opacity:0.3;">
        <i class="fa-solid fa-atom" style="position:absolute; top:10%; left:10%; color:#06b6d4; font-size:2rem; opacity:0.2;"></i>
        <i class="fa-solid fa-flask" style="position:absolute; top:80%; left:80%; color:#8b5cf6; font-size:3rem; opacity:0.2;"></i>
        <i class="fa-solid fa-dna" style="position:absolute; top:15%; right:15%; color:#10b981; font-size:2.5rem; opacity:0.2;"></i>
    </div>

    <div id="start-screen" class="screen active">
        <div class="cyber-card">
            <div class="reactor-core">
                <div class="orbit"></div>
                <i class="fa-solid fa-atom reactor-icon"></i>
            </div>
            <h1>NEON LAB</h1>
            <p class="text-cyan-200 mb-6 mt-2">STOICHIOMETRY PROTOCOLS</p>
            <button class="btn btn-primary w-full max-w-[250px] mb-3" onclick="startGame()">
                <i class="fa-solid fa-play"></i> START
            </button>
            <button class="btn btn-info w-full max-w-[250px]" onclick="showInfo()">
                <i class="fa-solid fa-graduation-cap"></i> INFO
            </button>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="panel-card">
            
            <div class="flex justify-between items-center mb-2 game-header">
                <div class="flex gap-2">
                    <button class="btn btn-icon" onclick="goHome()"><i class="fa-solid fa-house"></i></button>
                    <button class="btn btn-icon" onclick="resetLevel()"><i class="fa-solid fa-rotate-left"></i></button>
                </div>
                <div class="bg-slate-800 px-4 py-1 rounded-full border border-slate-600">
                    <span class="text-cyan-400 font-bold" id="level-badge">1 / 5</span>
                </div>
                <button class="btn btn-icon text-yellow-400 border-yellow-400/30" onclick="useHint()">
                    <i class="fa-regular fa-lightbulb"></i>
                </button>
            </div>

            <h2 id="eq-name" class="text-2xl text-white mb-2 font-bold">Synthesis</h2>
            
            <div id="equation-area" class="equation-area"></div>

            <div class="px-2">
                <div class="meter-container"><div id="stability-bar" class="meter-fill"></div></div>
            </div>

            <div class="bg-slate-800/50 rounded-xl p-3 mb-4">
                <div id="atom-grid" class="atom-grid"></div>
            </div>

            <div id="feedback" class="h-6 font-bold text-rose-400 mb-4 tracking-wide"></div>

            <div class="flex justify-center">
                <button id="check-btn" class="btn btn-check" onclick="checkAnswer()">BALANCE</button>
            </div>
        </div>
    </div>

    <div id="modal" class="modal" onclick="nextLevel()">
        <div class="modal-box">
            <div class="text-5xl text-emerald-400 mb-4"><i class="fa-solid fa-circle-check"></i></div>
            <h2 class="text-3xl font-bold text-white mb-2">STABLE!</h2>
            <p class="text-slate-400 mb-4">Equation balanced.</p>
            <p class="text-sm text-emerald-400 animate-pulse">TAP TO CONTINUE</p>
        </div>
    </div>

    <div id="end-modal" class="modal">
        <div class="modal-box" style="border-color: var(--gold);">
            <div class="text-5xl text-yellow-400 mb-4"><i class="fa-solid fa-flask"></i></div>
            <h2 class="text-2xl font-bold text-white mb-4">COMPLETE!</h2>
            <p class="text-slate-300 mb-6">All levels finished.</p>
            <button class="btn btn-gold w-full" onclick="goHome()">HOME</button>
        </div>
    </div>

    <div id="info-modal" class="modal">
        <div class="modal-box info-box">
            <h2 class="text-2xl font-bold text-violet-400 mb-4">INFO</h2>
            <ul class="text-left text-slate-300 space-y-3 mb-6">
                <li><i class="fa-solid fa-check text-success mr-2"></i> Balance atoms on left & right.</li>
                <li><i class="fa-solid fa-flask text-primary mr-2"></i> Change big numbers only.</li>
                <li><i class="fa-solid fa-brain text-accent mr-2"></i> Use logic to solve!</li>
            </ul>
            <button class="btn btn-info w-full" onclick="closeInfo()">OK</button>
        </div>
    </div>

    <script>
        // --- THE SCROLL BLOCKER SCRIPT ---
        // this stops the screen from moving when you swipe on background
        document.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });

        /* --- LOGIC --- */
        const ATOM_COLORS = { H: '#ef4444', O: '#3b82f6', C: '#10b981', N: '#f59e0b', Cl: '#a3e635', Na: '#fcd34d', Fe: '#f97316', Mg: '#e879f9', K: '#818cf8' };
        
        const LEVELS = [
            { name: "Water", r: [{f:"H₂", a:{H:2}}, {f:"O₂", a:{O:2}}], p: [{f:"H₂O", a:{H:2,O:1}}], s: [2,1,2] },
            { name: "Ammonia", r: [{f:"N₂", a:{N:2}}, {f:"H₂", a:{H:2}}], p: [{f:"NH₃", a:{N:1,H:3}}], s: [1,3,2] },
            { name: "Salt", r: [{f:"Na", a:{Na:1}}, {f:"Cl₂", a:{Cl:2}}], p: [{f:"NaCl", a:{Na:1,Cl:1}}], s: [2,1,2] },
            { name: "Methane", r: [{f:"CH₄", a:{C:1,H:4}}, {f:"O₂", a:{O:2}}], p: [{f:"CO₂", a:{C:1,O:2}}, {f:"H₂O", a:{H:2,O:1}}], s: [1,2,1,2] },
            { name: "Rust", r: [{f:"Fe", a:{Fe:1}}, {f:"O₂", a:{O:2}}], p: [{f:"Fe₂O₃", a:{Fe:2,O:3}}], s: [4,3,2] }
        ];

        let idx = 0;
        let gameData = [];
        
        function startGame() {
            gameData = [...LEVELS];
            idx = 0;
            document.getElementById('start-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            loadLevel();
        }

        function goHome() {
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('start-screen').classList.add('active');
            document.getElementById('modal').style.display = 'none';
            document.getElementById('end-modal').style.display = 'none';
        }

        function showInfo() { document.getElementById('info-modal').style.display = 'flex'; }
        function closeInfo() { document.getElementById('info-modal').style.display = 'none'; }
        function formatChem(str) { return str.replace(/(\d+)/g, '<sub>$1</sub>'); }

        function loadLevel() {
            const data = gameData[idx];
            document.getElementById('level-badge').innerText = `${idx + 1} / ${gameData.length}`;
            document.getElementById('eq-name').innerText = data.name;
            document.getElementById('feedback').innerText = "";
            document.getElementById('modal').style.display = 'none';
            renderEquation(data);
            updateCounts(data); 
        }

        function renderEquation(data) {
            const area = document.getElementById('equation-area');
            area.innerHTML = '';
            let inputIdx = 0;

            const makeComp = (c) => {
                const wrap = document.createElement('div');
                wrap.className = 'compound-wrapper';
                
                const row = document.createElement('div');
                row.className = 'flex items-center gap-1';
                
                const inp = document.createElement('input');
                inp.type = 'number'; inp.className = 'chem-input'; inp.value = 1; inp.min = 1; 
                inp.dataset.idx = inputIdx++;
                inp.oninput = (e) => { 
                    if(!e.target.value || e.target.value < 1) e.target.value = 1;
                    updateCounts(data); 
                };
                
                // CRITICAL: prevents scrolling inside the input on mobile
                inp.addEventListener('touchmove', (e) => { e.stopPropagation(); });

                row.innerHTML = `<span class="comp-label">${formatChem(c.f)}</span>`;
                row.prepend(inp);
                wrap.appendChild(row);
                
                const vis = document.createElement('div');
                vis.className = 'molecule-visuals';
                wrap.appendChild(vis);
                
                area.appendChild(wrap);
            };

            data.r.forEach((c, i) => {
                if(i>0) area.innerHTML += `<div class="text-slate-500 font-bold">+</div>`;
                makeComp(c);
            });
            area.innerHTML += `<div class="text-cyan-400 mx-2"><i class="fa-solid fa-arrow-right"></i></div>`;
            data.p.forEach((c, i) => {
                if(i>0) area.innerHTML += `<div class="text-slate-500 font-bold">+</div>`;
                makeComp(c);
            });
        }

        function updateCounts(data) {
            const inputs = [...document.querySelectorAll('.chem-input')];
            const vals = inputs.map(i => parseInt(i.value)||1);
            let rC = {}, pC = {}, atoms = new Set();
            let vIdx = 0;

            // Reactants
            data.r.forEach((comp, i) => {
                const m = vals[vIdx];
                renderVisuals(inputs[vIdx].closest('.compound-wrapper'), comp, m);
                for(let [a,c] of Object.entries(comp.a)) { rC[a] = (rC[a]||0) + c*m; atoms.add(a); }
                vIdx++;
            });
            
            // Products
            data.p.forEach((comp, i) => {
                const m = vals[vIdx];
                renderVisuals(inputs[vIdx].closest('.compound-wrapper'), comp, m);
                for(let [a,c] of Object.entries(comp.a)) { pC[a] = (pC[a]||0) + c*m; atoms.add(a); }
                vIdx++;
            });

            const grid = document.getElementById('atom-grid');
            grid.innerHTML = '';
            let total = 0, match = 0;

            atoms.forEach(a => {
                const r = rC[a]||0; const p = pC[a]||0;
                total++;
                if(r===p) match++;
                const col = ATOM_COLORS[a]||'#fff';
                grid.innerHTML += `
                    <div class="atom-card ${r===p?'match':'mismatch'} flex flex-col items-center">
                        <div class="text-xs font-bold" style="color:${col}">${a}</div>
                        <div class="flex gap-2 text-sm font-mono">
                            <span>${r}</span><span class="text-slate-500">:</span><span>${p}</span>
                        </div>
                    </div>
                `;
            });

            const pct = Math.round((match/total)*100);
            document.getElementById('stability-bar').style.width = pct + '%';
            if(pct === 100) document.getElementById('stability-bar').style.background = 'var(--success)';
            else document.getElementById('stability-bar').style.background = 'var(--secondary)';
        }

        function renderVisuals(wrap, comp, count) {
            const div = wrap.querySelector('.molecule-visuals');
            div.innerHTML = '';
            const max = Math.min(count, 4); 
            for(let k=0; k<max; k++) {
                for(let [a,c] of Object.entries(comp.a)) {
                     for(let j=0; j<c; j++) {
                         const d = document.createElement('div');
                         d.className = 'atom-orb';
                         d.style.background = ATOM_COLORS[a]||'#fff';
                         div.appendChild(d);
                     }
                }
                if(k < max-1) div.appendChild(document.createElement('div')).style.width='3px';
            }
        }

        function useHint() {
            const sol = gameData[idx].s;
            const inputs = document.querySelectorAll('.chem-input');
            let wrong = [];
            inputs.forEach((inp, k) => { if(parseInt(inp.value) !== sol[k]) wrong.push(k); });
            if(wrong.length) {
                const w = wrong[Math.floor(Math.random()*wrong.length)];
                inputs[w].value = sol[w];
                updateCounts(gameData[idx]);
                document.getElementById('feedback').innerText = "Hint used!";
            } else {
                document.getElementById('feedback').innerText = "It looks correct!";
            }
        }

        function checkAnswer() {
            const sol = gameData[idx].s;
            const inputs = document.querySelectorAll('.chem-input');
            const isCorrect = [...inputs].every((inp, k) => parseInt(inp.value) === sol[k]);
            
            if(isCorrect) {
                if(idx >= gameData.length-1) document.getElementById('end-modal').style.display = 'flex';
                else document.getElementById('modal').style.display = 'flex';
            } else {
                const fb = document.getElementById('feedback');
                fb.innerText = "NOT BALANCED!";
                setTimeout(() => fb.innerText = "", 1000);
            }
        }

        function resetLevel() { loadLevel(); }
        function nextLevel() { idx++; loadLevel(); }
    </script>
</body>
</html>
