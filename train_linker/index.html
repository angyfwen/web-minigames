<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Train Linker</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&family=Titan+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-sky: #87CEEB;
            --train-red: #ff595e;
            --train-blue: #1982c4;
            --train-green: #8ac926;
            --train-yellow: #ffca3a;
            --train-purple: #6a4c93;
            --train-orange: #ff924c;
            --train-indigo: #4B0082;
            --train-violet: #EE82EE;
        }

        body {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            height: 100vh; /* standard desktop/non-safari fallback */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-sky);
            background-image: 
                radial-gradient(circle, rgba(255,255,255,0.3) 2px, transparent 2px);
            background-size: 40px 40px;
            color: #333;
            overflow: hidden;
            user-select: none;
            animation: moveBg 20s linear infinite;
        }

        @keyframes moveBg {
            from { background-position: 0 0; }
            to { background-position: 0 40px; }
        }

        /* --- SCREENS --- */
        .screen {
            width: 100%; height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute; top: 0; left: 0; z-index: 10;
        }
        .screen.active { display: flex; animation: slideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- START SCREEN --- */
        .title-card {
            background: #fff;
            padding: 15px; 
            border-radius: 45px;
            text-align: center;
            box-shadow: 0 25px 0 rgba(0,0,0,0.15);
            max-width: 500px;
            width: 90%;
            position: relative;
            background-image: repeating-linear-gradient(
                -45deg, 
                var(--train-red), 
                var(--train-red) 20px, 
                var(--train-yellow) 20px, 
                var(--train-yellow) 40px
            );
        }

        .title-inner {
            background: white;
            border-radius: 35px;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow: hidden;
            border: 4px solid #333;
        }

        /* Industrial Bolts in Corners */
        .bolt {
            width: 15px; height: 15px; background: #ddd; border: 2px solid #999;
            border-radius: 50%; position: absolute; box-shadow: inset 1px 1px 2px white;
        }
        .tl { top: 15px; left: 15px; } .tr { top: 15px; right: 15px; }
        .bl { bottom: 15px; left: 15px; } .br { bottom: 15px; right: 15px; }

        .main-title {
            font-family: 'Titan One', cursive;
            font-size: 3.8rem;
            margin-top: 10px;
            margin-bottom: 40px;
            line-height: 0.9;
            color: var(--train-blue);
            text-shadow: 4px 4px 0 #badbf5, 6px 6px 0 #333;
            z-index: 2;
        }

        .main-title span { 
            display: block; font-size: 2.2rem; color: var(--train-green); 
            text-shadow: 3px 3px 0 #d4f7a3, 5px 5px 0 #333; margin-top: 5px; 
        }

        .menu-buttons {
            display: flex; flex-direction: column; gap: 15px; width: 80%; z-index: 2;
        }

        .btn-start, .btn-info {
            border: none; padding: 15px; font-size: 1.5rem;
            font-family: 'Titan One', cursive; border-radius: 50px; cursor: pointer;
            transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 10px;
            color: white; border: 3px solid rgba(0,0,0,0.1);
        }

        .btn-start {
            background: var(--train-green);
            box-shadow: 0 8px 0 #5f9609, 0 15px 10px rgba(0,0,0,0.2);
            animation: pulseBtn 2s infinite;
        }
        @keyframes pulseBtn { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .btn-info {
            background: var(--train-yellow); color: #856404;
            box-shadow: 0 8px 0 #c49b07, 0 15px 10px rgba(0,0,0,0.2);
            font-size: 1.2rem;
        }

        .btn-start:active, .btn-info:active { transform: translateY(8px) scale(0.98); box-shadow: none; animation: none; }
        .btn-start:hover { filter: brightness(1.1); }
        .btn-info:hover { filter: brightness(1.1); }

        /* --- GAME UI --- */
        .game-wrapper {
            width: 95%; max-width: 1200px; height: 90vh;
            display: flex; flex-direction: column; gap: 20px;
            position: relative; 
        }

        .hud-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.95); padding: 15px 20px;
            border-radius: 25px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            backdrop-filter: blur(5px); border-bottom: 5px solid #ddd;
        }

        .hud-left { display: flex; gap: 10px; }
        .icon-btn { background: #f0f0f0; border: none; width: 50px; height: 50px; border-radius: 15px; font-size: 1.2rem; cursor: pointer; color: #555; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 0 #ccc; transition: 0.1s; }
        .icon-btn:active { transform: translateY(4px); box-shadow: none; }

        .level-badge { background: var(--train-blue); color: white; padding: 10px 20px; border-radius: 15px; font-family: 'Titan One', cursive; font-size: 1.2rem; box-shadow: 0 5px 0 #0d4a75; white-space: nowrap; }
        .target-box { display: flex; flex-direction: column; align-items: center; flex-grow: 1; }
        .hud-label { font-size: 0.8rem; font-weight: 900; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .target-seq { font-family: 'Titan One', cursive; font-size: 1.8rem; color: var(--train-red); }

        /* PLAYGROUND CONTAINER (THE WINDOW) */
        .playground-window {
            flex-grow: 1;
            background-color: #8D6E63;
            border-radius: 30px;
            overflow-x: auto; /* Enable horizontal scroll */
            overflow-y: hidden;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.3);
            border: 8px solid #5D4037;
            position: relative;
            
            /* --- CUTE CUSTOM SCROLLBAR --- */
            scrollbar-width: thin;
            scrollbar-color: var(--train-yellow) #5D4037;
        }

        /* Webkit Scrollbar Styling */
        .playground-window::-webkit-scrollbar {
            height: 14px; /* Chunky height for easy tapping */
        }
        .playground-window::-webkit-scrollbar-track {
            background: #5D4037;
            border-radius: 0 0 20px 20px; /* Match container bottom */
        }
        .playground-window::-webkit-scrollbar-thumb {
            background-color: var(--train-yellow);
            border-radius: 20px;
            border: 3px solid #5D4037; /* Spacing around the thumb */
        }
        .playground-window::-webkit-scrollbar-thumb:hover {
            background-color: #ffda6a;
        }

        /* THE ACTUAL TRACKS (SCROLLABLE) */
        .playground {
            width: 100%; height: 100%;
            position: relative;
            background-image: 
                linear-gradient(90deg, transparent 48%, #5a4b45 48%, #5a4b45 52%, transparent 52%),
                linear-gradient(transparent 48%, #4e342e 48%, #4e342e 52%, transparent 52%);
            background-size: 100px 100px; 
        }

        /* --- TRAIN CAR --- */
        .train-car {
            position: absolute; width: 130px; height: 80px; display: flex; justify-content: center; align-items: center;
            font-family: 'Titan One', cursive; font-size: 2.5rem; color: white; text-shadow: 2px 2px 0 rgba(0,0,0,0.2);
            cursor: grab; z-index: 10; transition: transform 0.1s;
            background: linear-gradient(to bottom, var(--train-blue), #105a8b);
            border-radius: 15px 15px 5px 5px; border: 3px solid white; box-shadow: 5px 10px 10px rgba(0,0,0,0.3);
        }
        .train-car::after { content: ''; position: absolute; right: -15px; top: 50px; width: 25px; height: 12px; background: #333; border-radius: 0 5px 5px 0; border: 2px solid #555; z-index: -1; }
        .train-car::before { content: ''; position: absolute; left: -10px; top: 50px; width: 15px; height: 12px; background: #222; border-radius: 5px 0 0 5px; z-index: -1; }

        .wheels { position: absolute; bottom: -12px; width: 100%; display: flex; justify-content: space-around; pointer-events: none; }
        .wheel { width: 30px; height: 30px; background: #333; border-radius: 50%; border: 3px solid #777; box-shadow: 0 5px 5px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; }
        .wheel-inner { width: 8px; height: 8px; background: #999; border-radius: 50%; }

        .t-red { background: linear-gradient(to bottom, var(--train-red), #c9182b); }
        .t-blue { background: linear-gradient(to bottom, var(--train-blue), #105a8b); }
        .t-green { background: linear-gradient(to bottom, var(--train-green), #5a8516); }
        .t-yellow { background: linear-gradient(to bottom, var(--train-yellow), #e0a800); }
        .t-purple { background: linear-gradient(to bottom, var(--train-purple), #4a3567); }
        .t-orange { background: linear-gradient(to bottom, var(--train-orange), #b36635); }
        .t-indigo { background: linear-gradient(to bottom, var(--train-indigo), #2a004b); }
        .t-violet { background: linear-gradient(to bottom, var(--train-violet), #ad53ad); }
        .train-car:active { cursor: grabbing; transform: scale(1.05); z-index: 100; }

        .controls { display: flex; justify-content: center; gap: 20px; height: 80px; }
        .ctrl-btn { border: none; padding: 0 30px; border-radius: 20px; font-family: 'Titan One', cursive; font-size: 1.2rem; color: white; cursor: pointer; box-shadow: 0 6px 0 rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; transition: transform 0.1s; border-bottom: 4px solid rgba(0,0,0,0.2); }
        .ctrl-btn:active { transform: translateY(6px); box-shadow: none; border-bottom: none; }
        .btn-reset { background: var(--train-yellow); color: #5c4300; }
        .btn-check { background: var(--train-green); }
        .btn-break { background: var(--train-red); }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 2000;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.show { display: flex; animation: fadeIn 0.3s; }
        
        .modal-card {
            background: white; padding: 40px; border-radius: 30px; text-align: center;
            border: 8px solid #ccc; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            max-width: 450px; width: 90%; animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .modal-card.win { border-color: var(--train-green); }
        .modal-card.win .modal-title { color: var(--train-green); }
        .modal-card.fail { border-color: var(--train-red); }
        .modal-card.fail .modal-title { color: var(--train-red); }
        
        .modal-title { font-family: 'Titan One', cursive; font-size: 2.5rem; margin: 0; }
        .modal-text { font-size: 1.2rem; color: #555; margin: 20px 0; font-weight: bold; line-height: 1.5; white-space: pre-wrap; }
        .modal-stars { font-size: 3rem; color: var(--train-yellow); margin-bottom: 20px; text-shadow: 0 3px 0 #d4a000; }
        @keyframes bounceIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- INFO POPUP --- */
        .info-card {
            background: #fff;
            padding: 10px; /* Gap for border */
            border-radius: 30px;
            width: 90%; max-width: 600px;
            background-image: repeating-linear-gradient(-45deg, var(--train-red), var(--train-red) 15px, var(--train-yellow) 15px, var(--train-yellow) 30px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center; position: relative;
        }

        .info-inner {
            background: #fff; border-radius: 20px; padding: 30px; border: 4px solid #333;
        }

        .info-header {
            font-family: 'Titan One', cursive; font-size: 1.8rem; color: var(--train-blue); margin-bottom: 20px;
            text-shadow: 2px 2px 0 #ddd; text-transform: uppercase;
        }

        .info-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; margin-bottom: 25px;
        }

        .info-item {
            background: #f9f9f9; padding: 15px; border-radius: 15px; border: 2px solid #eee;
        }

        .info-icon { font-size: 2.5rem; margin-bottom: 10px; display: block; }
        .info-title { font-weight: 900; color: #333; display: block; margin-bottom: 5px; font-size: 1rem; }
        .info-desc { font-size: 0.8rem; color: #666; line-height: 1.3; }

        .btn-ok {
            background: var(--train-green); color: white; border: none; padding: 10px 40px;
            border-radius: 50px; font-family: 'Titan One', cursive; font-size: 1.5rem; cursor: pointer;
            box-shadow: 0 6px 0 #5f9609; transition: 0.1s;
        }
        .btn-ok:active { transform: translateY(6px); box-shadow: none; }

        .close-x {
            position: absolute; top: -15px; right: -15px; width: 40px; height: 40px;
            background: var(--train-red); color: white; border-radius: 50%; border: 3px solid white;
            font-weight: bold; font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }

        /* --- MOBILE PATCH (SIDE SCROLLER & LAYOUT) --- */
        @media (max-width: 768px) {
            
            /* Keep body height fix for iOS Safari */
            body { 
                position: fixed; 
                width: 100%; 
                min-height: 100vh;
                height: auto; 
                overflow: hidden;
                background-size: 20px 20px;
            }
            .screen {
                height: 100vh; /* Make sure screens still take up the visible area */
            }

            /* START SCREEN FIX: More Space */
            .title-card { width: 85%; max-height: 85vh; overflow-y: auto; padding: 10px; }
            .title-inner { padding: 30px 10px; }
            .main-title { font-size: 2.8rem; margin-bottom: 30px; } 
            .main-title span { font-size: 1.5rem; }
            .menu-buttons { gap: 25px; width: 90%; } 
            .btn-start, .btn-info { font-size: 1.1rem; padding: 12px; }

            /* GAME SCREEN FIX: Use flex to center the shrunken content vertically */
            #game-screen.screen.active {
                justify-content: center;
                align-items: center;
                display: flex;
            }

            /* GAME LAYOUT */
            .game-wrapper { 
                /* Scale and Nudge */
                transform: scale(0.80) translateY(40px); /* Pushes the whole scaled block down */
                transform-origin: center top; 
                
                width: 100vw; 
                max-width: none;
                height: 100vh; 
                margin: 0; 
                padding: 0; /* Remove top/bottom padding to let translateY handle position */
                box-sizing: border-box; 
                gap: 10px; 
            }

            /* This ensures the scrollable area is scaled correctly */
            .playground-window {
                flex-grow: 1;
                /* Adjust height calculation to fill space between HUD and Controls */
                height: calc(100% - 190px); 
                min-height: 300px;
            }

            /* COMPACT HUD (minor adjustment needed due to scaling) */
            .hud-bar { 
                padding: 8px 12px; flex-wrap: wrap; justify-content: center; gap: 5px; min-height: 50px;
            }
            .hud-left { 
                position: absolute; top: 8px; left: 10px; transform: scale(0.85); transform-origin: left top; 
            }
            .level-badge { 
                position: absolute; top: 8px; right: 10px; font-size: 0.9rem; padding: 6px 12px; 
            }
            .target-box { margin-top: 0; width: 100%; order: 3; padding-top: 5px; } 
            .hud-label { display: none; }
            .target-seq { font-size: 1.3rem; margin-top: 25px; }

            /* PLAYGROUND: Make it wide */
            .playground {
                /* Recalculate width to counteract the new 0.80 scale */
                width: calc(180% / 0.80); 
                height: 100%;
                border: none;
                border-radius: 0;
            }

            /* Train adjustments for mobile */
            .train-car { width: 110px; height: 70px; font-size: 1.8rem; } 
            .wheels { bottom: -10px; }
            .wheel { width: 25px; height: 25px; }

            /* Coupler Logic is handled in CSS so it connects visually with 110px cars */
            .train-car::after { right: -15px; width: 25px; height: 12px; top: 40px; }
            .train-car::before { left: -10px; width: 15px; height: 12px; top: 40px; }

            /* CONTROLS (Removed redundant margin-bottom) */
            .controls { height: 50px; gap: 8px; margin-bottom: 0; } 
            .ctrl-btn { font-size: 0.8rem; padding: 0 15px; height: 45px; border-radius: 15px; }
            
            /* --- MODALS FIX --- */
            .modal-card { 
                /* ðŸš‚ Small adjustment: narrower and slightly thicker border-radius */
                width: 80%; 
                padding: 15px; /* Less internal padding */
                border-radius: 20px;
                border: 6px solid #ccc; /* Slightly thinner border */
            }
            .modal-title { font-size: 1.8rem; } /* Smaller font */
            .modal-stars { font-size: 2.5rem; margin-bottom: 10px; } /* Smaller icon */
            .modal-text { font-size: 1rem; margin: 10px 0; } /* Smaller text */
            
            /* INFO CARD FIX */
            .info-card { 
                width: 85%;
                border-radius: 20px;
            }
            .info-inner { 
                padding: 20px; 
            }
            .info-header { 
                font-size: 1.5rem; 
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>

    <div id="start-screen" class="screen active">
        <div class="title-card">
            <div class="title-inner">
                <div class="bolt tl"></div><div class="bolt tr"></div>
                <div class="bolt bl"></div><div class="bolt br"></div>

                <h1 class="main-title">MAGNETIC<br><span>TRAINS</span></h1>
                
                <div class="menu-buttons">
                    <button class="btn-start" onclick="startGame()">
                        <i class="fa-solid fa-play"></i> START ENGINE
                    </button>
                    <button class="btn-info" onclick="showInfo()">
                        <i class="fa-solid fa-graduation-cap"></i> EDUCATIONAL VALUE
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div class="game-wrapper">
            <div class="hud-bar">
                <div class="hud-left">
                    <button class="icon-btn" onclick="goHome()"><i class="fa-solid fa-house"></i></button>
                    <button class="icon-btn" onclick="toggleMute()"><i class="fa-solid fa-volume-high" id="vol-icon"></i></button>
                </div>
                <div class="target-box">
                    <div class="hud-label">Connect Order</div>
                    <div class="target-seq" id="target-display">Loading...</div>
                </div>
                <div class="level-badge" id="level-display">Level 1</div>
            </div>

            <div class="playground-window">
                <div class="playground" id="playground"></div>
            </div>

            <div class="controls">
                <button class="ctrl-btn btn-break" onclick="breakAll()">
                    <i class="fa-solid fa-link-slash"></i> BREAK
                </button>
                <button class="ctrl-btn btn-reset" onclick="initLevel()">
                    <i class="fa-solid fa-rotate-right"></i> RESET
                </button>
                <button class="ctrl-btn btn-check" onclick="checkWin()">
                    <i class="fa-solid fa-check"></i> DEPART
                </button>
            </div>
        </div>
    </div>

    <div id="win-modal" class="modal-overlay">
        <div class="modal-card" id="win-card">
            <div class="modal-title" id="modal-h">GREAT JOB!</div>
            <div class="modal-stars" id="modal-icon">
                <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
            </div>
            <div class="modal-text" id="win-msg">Level Complete!</div>
            <center>
                <button class="btn-start" id="next-level-btn" onclick="nextLevel()">
                    NEXT <i class="fa-solid fa-arrow-right"></i>
                </button>
            </center>
        </div>
    </div>

    <div id="info-modal" class="modal-overlay">
        <div class="info-card">
            <button class="close-x" onclick="closeInfo()">X</button>
            <div class="info-inner">
                <div class="info-header"><i class="fa-solid fa-brain"></i> HOW IS THIS EDUCATIONAL?</div>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-icon" style="color: var(--train-yellow);"><i class="fa-solid fa-brain"></i></span>
                        <div>
                            <span class="info-title">Brain Power</span>
                            <span class="info-desc">Reinforces spelling and pattern recognition.</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <span class="info-icon" style="color: var(--train-blue);"><i class="fa-solid fa-arrow-down-1-9"></i></span>
                        <div>
                            <span class="info-title">Algorithmic Logic</span>
                            <span class="info-desc">Understanding that sequence and order matter.</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <span class="info-icon" style="color: var(--train-green);"><i class="fa-solid fa-puzzle-piece"></i></span>
                        <div>
                            <span class="info-title">Problem Solving</span>
                            <span class="info-desc">Unscrambling letters forces cognitive processing.</span>
                        </div>
                    </div>
                </div>
                <button class="btn-ok" onclick="closeInfo()">GOT IT!</button>
            </div>
        </div>
    </div>

    <script>
        // --- SOUND ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let isMuted = false;

        function playSound(type) {
            if (isMuted) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;

            if (type === 'click') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(600, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            }
            else if (type === 'snap') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            }
            else if (type === 'win') {
                const notes = [523.25, 659.25, 783.99, 1046.50];
                notes.forEach((f, i) => {
                    let o = audioCtx.createOscillator();
                    let g = audioCtx.createGain();
                    o.type = 'triangle'; o.frequency.value = f;
                    o.connect(g); g.connect(audioCtx.destination);
                    g.gain.setValueAtTime(0.1, now + i*0.1);
                    g.gain.exponentialRampToValueAtTime(0.01, now + i*0.1 + 0.3);
                    o.start(now + i*0.1); o.stop(now + i*0.1 + 0.3);
                });
            }
            else if (type === 'error') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('vol-icon').className = isMuted ? 'fa-solid fa-volume-xmark' : 'fa-solid fa-volume-high';
        }

        // --- WORD BANKS ---
        const wordPools = {
            3: ['CAT', 'DOG', 'BUS', 'VAN', 'SUN', 'FOX', 'BAT', 'HAT', 'PIG', 'ANT', 'COW'],
            4: ['SHIP', 'BOAT', 'RAIL', 'TRAM', 'TAXI', 'JEEP', 'BIKE', 'CART', 'KITE'],
            5: ['TRAIN', 'PLANE', 'TRACK', 'STEAM', 'METRO', 'SMILE', 'ZEBRA', 'TIGER', 'ROBOT']
        };

        // --- LEVELS ---
        const levels = [
            { id: 1, type: 'word', length: 3, colors: ['t-red', 't-blue', 't-green'] }, 
            { id: 2, type: 'word', length: 3, colors: ['t-orange', 't-blue', 't-purple'] }, 
            { id: 3, type: 'numbers', length: 5, colors: ['t-purple', 't-red', 't-blue', 't-green', 't-yellow'] },
            { id: 4, type: 'word', length: 4, colors: ['t-red', 't-orange', 't-yellow', 't-green'] }, 
            { id: 5, type: 'word', length: 5, colors: ['t-indigo', 't-violet', 't-red', 't-green', 't-blue'] } 
        ];

        // --- GAME STATE ---
        let currentLevelIdx = 0;
        let cars = [];
        let targetSeq = [];
        let currentColors = [];
        let draggedCar = null;
        let offset = { x: 0, y: 0 };
        
        // --- MOBILE DETECT ---
        const isMobile = window.innerWidth <= 768;
        const CAR_W = isMobile ? 110 : 130; // UPDATED: Logic now matches CSS width
        const SNAP_DIST = 60;

        // --- DOM ---
        const playground = document.getElementById('playground');
        const targetDisplay = document.getElementById('target-display');
        const levelDisplay = document.getElementById('level-display');
        const winModal = document.getElementById('win-modal');
        const winMsg = document.getElementById('win-msg');
        const modalTitle = document.getElementById('modal-h');
        const modalStars = document.getElementById('modal-icon');
        const nextBtn = document.getElementById('next-level-btn');
        const winCard = document.getElementById('win-card');
        const infoModal = document.getElementById('info-modal');

        // --- NAVIGATION ---
        function startGame() {
            playSound('click');
            document.getElementById('start-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            currentLevelIdx = 0;
            initLevel();
        }

        function goHome() {
            playSound('click');
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('start-screen').classList.add('active');
            winModal.classList.remove('show');
        }

        function showInfo() {
            playSound('click');
            infoModal.classList.add('show');
        }

        function closeInfo() {
            playSound('click');
            infoModal.classList.remove('show');
        }

        // --- LOGIC ---
        function initLevel() {
            playground.innerHTML = '';
            cars = [];
            winModal.classList.remove('show');
            
            const level = levels[currentLevelIdx];
            levelDisplay.innerText = "Level " + level.id;
            
            let displayData = [];

            if (level.type === 'numbers') {
                const startNum = Math.floor(Math.random() * 10) + 1;
                displayData = [];
                for(let i=0; i<level.length; i++) {
                    displayData.push(String(startNum + i));
                }
                targetSeq = [...displayData];
                currentColors = level.colors;
            } 
            else if (level.type === 'word') {
                const pool = wordPools[level.length];
                const randWord = pool[Math.floor(Math.random() * pool.length)];
                targetSeq = randWord.split('');
                displayData = [...targetSeq];
                currentColors = level.colors;
            }

            targetDisplay.innerText = targetSeq.join(' âžœ ');

            displayData.forEach((val, i) => {
                const c = createCar(val, i, currentColors[i % currentColors.length]);
                cars.push(c);
            });

            scatterCars();
        }

        function createCar(val, id, colorClass) {
            const el = document.createElement('div');
            el.className = `train-car ${colorClass}`;
            el.innerText = val;
            el.dataset.id = id;
            
            const wheels = document.createElement('div');
            wheels.className = 'wheels';
            wheels.innerHTML = `<div class="wheel"><div class="wheel-inner"></div></div><div class="wheel"><div class="wheel-inner"></div></div>`;
            el.appendChild(wheels);
            
            el.addEventListener('mousedown', onMouseDown);
            el.addEventListener('touchstart', onTouchStart, {passive: false});
            playground.appendChild(el);
            
            return { id, val, el, x: 0, y: 0, next: null, prev: null };
        }

        function scatterCars() {
            const rect = playground.getBoundingClientRect();
            cars.forEach(c => {
                c.next = null;
                c.prev = null;
                c.x = 20 + Math.random() * (rect.width - (CAR_W + 50));
                c.y = 20 + Math.random() * (rect.height - 100);
                updatePos(c);
            });
        }

        function updatePos(c) {
            c.el.style.left = c.x + 'px';
            c.el.style.top = c.y + 'px';
            if (c.next) {
                // FIXED: Tighter coupling distance based on device type
                c.next.x = c.x + CAR_W + 5;
                c.next.y = c.y;
                updatePos(c.next);
            }
        }

        // --- INTERACTION ---
        function onMouseDown(e) { startDrag(e.target, e.clientX, e.clientY); document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', onMouseUp); }
        function onTouchStart(e) { e.preventDefault(); const touch = e.touches[0]; startDrag(e.target, touch.clientX, touch.clientY); document.addEventListener('touchmove', onTouchMove, {passive: false}); document.addEventListener('touchend', onTouchEnd); }

        function startDrag(target, clientX, clientY) {
            const carEl = target.closest('.train-car');
            if(!carEl) return;
            const id = carEl.dataset.id;
            draggedCar = cars.find(c => c.id == id);
            
            if (draggedCar.prev) { draggedCar.prev.next = null; draggedCar.prev = null; }

            const rect = draggedCar.el.getBoundingClientRect();
            offset.x = clientX - rect.left;
            offset.y = clientY - rect.top;
            draggedCar.el.style.zIndex = 100;
        }

        function onMouseMove(e) { moveDrag(e.clientX, e.clientY); }
        function onTouchMove(e) { e.preventDefault(); moveDrag(e.touches[0].clientX, e.touches[0].clientY); }

        function moveDrag(clientX, clientY) {
            if (!draggedCar) return;
            const rect = playground.getBoundingClientRect();
            draggedCar.x = clientX - rect.left - offset.x;
            draggedCar.y = clientY - rect.top - offset.y;
            updatePos(draggedCar);
        }

        function onMouseUp() { endDrag(); document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); }
        function onTouchEnd() { endDrag(); document.removeEventListener('touchmove', onTouchMove); document.removeEventListener('touchend', onTouchEnd); }

        function endDrag() {
            if (!draggedCar) return;
            checkForSnap(draggedCar);
            draggedCar.el.style.zIndex = 10;
            draggedCar = null;
        }

        function checkForSnap(current) {
            for (let other of cars) {
                if (other === current) continue;
                if (other.next) continue; 
                
                // Fixed distance check using dynamic CAR_W
                const dist = Math.hypot(current.x - (other.x + CAR_W + 5), current.y - other.y);
                
                if (dist < SNAP_DIST) {
                    if (findHead(other) === current) return; 
                    current.x = other.x + CAR_W + 5;
                    current.y = other.y;
                    other.next = current;
                    current.prev = other;
                    updatePos(other);
                    playSound('snap');
                    break;
                }
            }
        }

        function findHead(c) {
            let curr = c;
            while (curr.prev) curr = curr.prev;
            return curr;
        }

        function breakAll() {
            playSound('click');
            cars.forEach(c => { c.next = null; c.prev = null; });
            scatterCars();
        }

        function checkWin() {
            let heads = cars.filter(c => c.prev === null);
            if (heads.length !== 1) { showModal("Connect ALL cars!", false); return; }
            
            let current = heads[0];
            let count = 0;
            let match = true;
            
            while (current) {
                if (count >= targetSeq.length || current.val !== targetSeq[count]) { match = false; break; }
                current = current.next; count++;
            }
            
            if (match && count === targetSeq.length && count === cars.length) { showModal("Excellent Work!", true); } 
            else { showModal("Wrong Order!", false); }
        }

        function showModal(msg, success) {
            winMsg.innerText = msg;
            if (success) {
                playSound('win');
                winCard.className = 'modal-card win';
                modalTitle.innerText = "GREAT JOB!";
                modalStars.innerHTML = '<i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>';
                winModal.classList.add('show');
                
                if (currentLevelIdx < levels.length - 1) {
                    nextBtn.innerHTML = `NEXT LEVEL <i class="fa-solid fa-arrow-right"></i>`;
                    nextBtn.onclick = nextLevel;
                } else {
                    nextBtn.innerHTML = `HOME <i class="fa-solid fa-house"></i>`;
                    nextBtn.onclick = goHome;
                    winMsg.innerText = "SHIFT ENDED!\nTRAIN DOCKED ðŸš‰";
                    modalTitle.innerText = "TERMINAL REACHED";
                }
                nextBtn.style.display = 'flex';
            } else {
                playSound('error');
                winCard.className = 'modal-card fail';
                modalTitle.innerText = "OOPS!";
                modalStars.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i>';
                winModal.classList.add('show');
                nextBtn.style.display = 'none';
                setTimeout(() => winModal.classList.remove('show'), 1500);
            }
        }

        function nextLevel() { playSound('click'); currentLevelIdx++; initLevel(); }
    </script>
</body>
</html>

