<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>bio war</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root{
            --bg-deep:#1a0505;
            --card-bg:rgba(40,10,20,0.8);
            --accent-gold:#ffd700;
            --btn-start-top:#33cc33; --btn-start-bot:#006600;
            --btn-info-top:#ffd700; --btn-info-bot:#b8860b;
            --btn-red-top:#ff4444; --btn-red-bot:#990000;
            --btn-blue-top:#4488ff; --btn-blue-bot:#004499;
            --text-light:#ffcccc;
            --scroll-bg:rgba(255,255,255,0.06);
            --scroll-thumb:rgba(255,255,255,0.14);
            --scroll-thumb-hover:rgba(255,255,255,0.26);
        }

        *{ -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

        body{
            font-family:'nunito',sans-serif;
            margin:0;height:100vh;
            display:flex;justify-content:center;align-items:center;
            overflow:hidden;background-color:var(--bg-deep);color:white;
            user-select:none;-webkit-user-select:none;touch-action:none;-webkit-touch-callout:none;
        }

        #game-wrapper{
            position:relative;width:100%;height:100%;display:flex;justify-content:center;align-items:center;
            background-image:
                radial-gradient(circle at 50% 50%, rgba(255,0,0,0.15) 0%, transparent 60%),
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size:100% 100%,50px 50px,50px 50px;
        }

        canvas{ position:absolute; top:0; left:0; z-index:1; display:block; }

        .interactive{ pointer-events:auto; }

        .screen{
            position:absolute;width:100%;height:100%;display:none;flex-direction:column;
            align-items:center;justify-content:center;background:rgba(20,0,0,0.7);backdrop-filter:blur(8px);
            transition:opacity .3s;z-index:20;perspective:1000px;padding:20px;
        }
        .screen.active{ display:flex; animation: fadeIn .45s ease-out; }
        @keyframes fadeIn{ from{ opacity:0; transform:scale(.98);} to{ opacity:1; transform:scale(1); } }

        h1{
            font-family:'fredoka one',cursive;font-size:6rem;margin:0;
            background:linear-gradient(to bottom,#ff4444,#ff9999);
            -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
            filter:drop-shadow(0px 10px 0px rgba(0,0,0,.5));text-transform:uppercase;letter-spacing:4px;text-align:center;line-height:1.05;
        }

        .subtitle{ font-size:1.5rem;color:var(--text-light);font-weight:900;margin-top:15px;text-transform:uppercase;letter-spacing:3px;text-align:center;padding:0 20px;text-shadow:0 2px 10px rgba(255,0,0,0.5); }

        @media (max-width:850px),(max-height:500px){ h1{ font-size:3rem; letter-spacing:2px; } .subtitle{ font-size:1rem; margin-top:5px; } }

        .btn-group{ display:flex;gap:20px;margin-top:50px;flex-wrap:wrap;justify-content:center; }
        .modern-btn{
            border:none;padding:18px 50px;border-radius:50px;font-family:'fredoka one',cursive;font-size:1.5rem;color:white;
            cursor:pointer;transition:transform .1s,filter .2s,box-shadow .2s;text-transform:uppercase;display:flex;align-items:center;gap:12px;
            box-shadow:0px 8px 0px rgba(0,0,0,.3),0px 20px 30px rgba(0,0,0,.4);position:relative;overflow:hidden;text-shadow:0 1px 2px rgba(0,0,0,.3);
            margin-bottom:6px;
        }
        @media (max-width:850px),(max-height:500px){ .btn-group{ margin-top:20px; gap:10px; } .modern-btn{ padding:10px 25px; font-size:1.1rem; box-shadow:0px 4px 0px rgba(0,0,0,.3); } }

        .modern-btn::after{ content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%; background:linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.28) 50%, rgba(255,255,255,0) 100%); transform:rotate(45deg) translate(-100%,-100%); transition:transform .5s; }
        .modern-btn:hover::after{ transform:rotate(45deg) translate(100%,100%); }
        .modern-btn:active{ transform:translateY(6px); box-shadow:0px 2px 0px rgba(0,0,0,.3); }
        .modern-btn:hover{ filter:brightness(1.08); transform:translateY(-2px); }

        .btn-start{ background:linear-gradient(to bottom,var(--btn-start-top),var(--btn-start-bot)); box-shadow:0px 8px 0px #004d00; }
        .btn-info{ background:linear-gradient(to bottom,var(--btn-info-top),var(--btn-info-bot)); box-shadow:0px 8px 0px #8b6914; }
        .btn-danger{ background:linear-gradient(to bottom,var(--btn-red-top),var(--btn-red-bot)); box-shadow:0px 8px 0px #550000; }
        .btn-help{ background:linear-gradient(to bottom,var(--btn-blue-top),var(--btn-blue-bot)); box-shadow:0px 8px 0px #003366; }
        .btn-icon{ padding:15px;border-radius:50%;width:50px;height:50px;justify-content:center; }

        #game-hud{ position:absolute; top:0; left:0; width:100%; display:none; justify-content:space-between; padding:20px 40px; padding-top:max(20px,env(safe-area-inset-top)); padding-left:max(40px,env(safe-area-inset-left)); padding-right:max(40px,env(safe-area-inset-right)); box-sizing:border-box; z-index:15; pointer-events:none; }

        .hud-card{ background:var(--card-bg); border-radius:20px; padding:15px 25px; border:2px solid rgba(255,255,255,.1); backdrop-filter:blur(10px); display:flex; flex-direction:column; align-items:flex-start; box-shadow:0 10px 20px rgba(0,0,0,.3); min-width:150px; }

        @media (max-width:850px),(max-height:500px){ #game-hud{ padding:10px 15px; } .hud-card{ padding:8px 12px; min-width:80px; border-radius:12px; } .hud-label{ font-size:.6rem; margin-bottom:2px; } .hud-value{ font-size:1rem; text-shadow:none; } .progress-container{ height:6px; margin-top:3px; } #health-text{ font-size:.6rem !important; } }

        .hud-label{ font-family:'fredoka one'; color:var(--text-light); font-size:.9rem; margin-bottom:5px; text-transform:uppercase; }
        .hud-value{ font-family:'fredoka one'; font-size:1.8rem; color:white; text-shadow:0 2px 4px rgba(0,0,0,.5); }
        .progress-container{ width:100%; height:12px; background:rgba(0,0,0,.5); border-radius:10px; overflow:hidden; margin-top:5px; }
        .progress-bar{ height:100%; width:100%; background: linear-gradient(90deg,#ff4444,#ff8800); transition:width .3s; }

        /* Left Controls */
        #controls-area{ position:absolute; bottom:0; left:0; display:none; gap:15px; z-index:15; padding-bottom:max(30px,env(safe-area-inset-bottom)); padding-left:max(30px,env(safe-area-inset-left)); }
        
        /* Rainbow Menu Button (Bottom Right) */
        .menu-btn-rainbow {
            position: absolute;
            bottom: 30px;
            right: 30px;
            padding: 12px 24px;
            border-radius: 20px;
            color: white;
            font-family: 'Nunito', sans-serif;
            font-weight: 900;
            text-decoration: none;
            text-transform: lowercase;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            background: linear-gradient(90deg, #ff6b6b, #ffd36b, #4ade80, #60a5fa, #a78bfa);
            background-size: 300% 100%; 
            animation: gradientMove 4s ease infinite; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            transition: transform 0.2s;
            border: 2px solid rgba(255,255,255,0.2);
            pointer-events: auto;
        }
        .menu-btn-rainbow:hover { transform: scale(1.05); }
        .menu-btn-rainbow:active { transform: scale(0.95); }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @media (max-width:850px),(max-height:500px){ 
            #controls-area{ padding-bottom:10px; padding-left:10px; gap:8px; } 
            .btn-icon{ width:40px; height:40px; font-size:.9rem; padding:0; } 
            .menu-btn-rainbow { bottom: 10px; right: 10px; padding: 8px 16px; font-size: 0.9rem; }
        }

        .modal-overlay{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.8); z-index:100; display:none; justify-content:center; align-items:center; backdrop-filter:blur(5px); padding:20px; box-sizing:border-box; }

        .modal-box{ background:#1a0000; border:3px solid rgba(255,100,100,.3); padding:36px; border-radius:30px; max-width:520px; width:100%; text-align:left; box-shadow:0 20px 50px rgba(0,0,0,.7); color:#ddd; transform:scale(.96); transition:transform .18s; max-height:calc(100vh - 80px); display:flex; flex-direction:column; gap:12px; }

        .modal-content{ overflow-y:auto; max-height:calc(100vh - 220px); padding-right:8px; }
        .modal-content::-webkit-scrollbar{ width:10px; } .modal-content::-webkit-scrollbar-track{ background:var(--scroll-bg); border-radius:10px; } .modal-content::-webkit-scrollbar-thumb{ background:var(--scroll-thumb); border-radius:10px; border:2px solid transparent; background-clip:padding-box; } .modal-content::-webkit-scrollbar-thumb:hover{ background:var(--scroll-thumb-hover); }
        .modal-content{ scrollbar-width:thin; scrollbar-color:var(--scroll-thumb) var(--scroll-bg); }

        @media (max-width:850px),(max-height:500px){ .modal-box{ padding:18px; max-width:92%; max-height:86vh; } .modal-content{ max-height:calc(100vh - 170px); } .modal-box h2{ font-size:1.15rem; } .modal-box p,.modal-box li{ font-size:.96rem; line-height:1.4; } }

        .modal-overlay.active .modal-box{ transform:scale(1); } .modal-box h2{ font-family:'fredoka one'; color:var(--accent-gold); margin:0; } .modal-box p{ line-height:1.5; font-size:1.05rem; margin:0; }

        .edu-short{ display:none; } @media (max-width:520px){ .edu-verbose{ display:none; } .edu-short{ display:block; font-size:1rem; color:#eee; } }

        #rotate-message{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#1a0505; z-index:999; flex-direction:column; justify-content:center; align-items:center; text-align:center; color:white; } @media only screen and (orientation:portrait) and (max-width:768px){ #rotate-message{ display:flex; } #game-wrapper{ display:none; } }

        #game-over-screen{ padding:28px 20px; align-items:center; justify-content:center; gap:10px; text-align:center; overflow:auto; }
        #go-icon{ font-size:5rem; margin-bottom:8px; text-shadow:0 0 20px currentColor; }
        #go-title{ font-size:3.5rem; margin:0; line-height:1.02; text-transform:uppercase; letter-spacing:3px; }
        #go-reason{ font-size:1.05rem; margin-top:6px; color:#ffaaaa; padding: 0 16px; }
        #go-score{ font-size:1.25rem; margin-bottom:10px; text-transform:none; }

        #game-over-screen .btn-area{ width:100%; display:flex; justify-content:center; margin-top:8px; }
        #game-over-screen .btn-group{ flex-direction:row; gap:14px; flex-wrap:wrap; justify-content:center; width:100%; max-width:680px; }

        @media (max-width:640px){
            #game-over-screen .btn-group{ flex-direction:column; gap:10px; align-items:center; }
            #game-over-screen .modern-btn{ padding:12px 18px; font-size:1.05rem; border-radius:18px; width:92%; max-width:420px; }
            #game-over-screen .modern-btn.full{ width:92%; }
            #game-over-screen #go-icon{ font-size:3.2rem !important; }
            #go-title{ font-size:2.2rem !important; letter-spacing:2px; }
            #go-reason{ font-size:.96rem; padding:0 8px; }
            #go-score{ font-size:1rem; }
        }

        @media (max-height:420px){ .modal-box{ max-height:calc(100vh - 40px); overflow-y:auto; } #game-over-screen{ padding-top:12px; padding-bottom:12px; } }
        
        @media (max-width: 850px), (max-height: 500px) {
            #go-icon { font-size: 2.5rem !important; margin-bottom: 6px; }
            #go-title { font-size: 2rem !important; letter-spacing: 1px !important; line-height: 1.1; }
            #go-reason { font-size: 0.85rem !important; padding: 0 10px !important; }
            #go-score { font-size: 0.9rem !important; margin-bottom: 10px !important; }
            #game-over-screen .modern-btn { position: relative; display: flex; justify-content: center; align-items: center; gap: 0; padding-left: 48px; box-sizing: border-box; }
            #game-over-screen .modern-btn i.fa-solid { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); pointer-events: none; }
            @media (max-width: 420px) { #game-over-screen .modern-btn { padding-left: 42px; padding-right: 18px; } }
        }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>

<div id="rotate-message">
    <i class="fa-solid fa-rotate" style="font-size:4rem;color:#ffd700;margin-bottom:20px;"></i>
    <h2 style="font-family:'fredoka one';margin:0;">please rotate device</h2>
    <p style="font-family:'nunito';opacity:.75;">this mission prefers landscape mode.</p>
</div>

<a href="https://angyfwen.github.io/web-minigames/" class="menu-btn-rainbow">
    <i class="fa-solid fa-gamepad"></i> menu
</a>

<div id="game-wrapper">

    <div id="start-screen" class="screen active interactive">
        <h1 id="main-title">! biology warface !<br>rapid fire</h1>
        <div class="subtitle">collect 30 pathogens in 30 seconds!</div>
        <div class="btn-group">
            <button class="modern-btn btn-start" onclick="GameApp.startGame()"><i class="fa-solid fa-play"></i> engage</button>
            <button class="modern-btn btn-info" onclick="GameApp.toggleInfo('edu')"><i class="fa-solid fa-graduation-cap"></i> educational value</button>
        </div>
    </div>

    <div id="game-hud">
        <div class="hud-card"><div class="hud-label"><i class="fa-solid fa-virus"></i> quota (300)</div><div class="hud-value" id="score-val">0 / 300</div></div>
        <div class="hud-card" style="align-items:center;"><div class="hud-label">time remaining</div><div class="hud-value" id="timer-val" style="color:var(--accent-gold)">30</div></div>
        <div class="hud-card"><div class="hud-label"><i class="fa-solid fa-heart-pulse"></i> integrity</div><div class="progress-container"><div class="progress-bar" id="health-bar"></div></div><div style="font-size:.8rem;margin-top:5px;color:#aaa;" id="health-text">100%</div></div>
    </div>

    <div id="controls-area" class="interactive">
        <button class="modern-btn btn-red btn-icon" onclick="GameApp.goHome()" title="abort mission" style="background:linear-gradient(to bottom,#ff4444,#990000);box-shadow:0px 8px 0px #550000;"><i class="fa-solid fa-house"></i></button>
        <button class="modern-btn btn-info btn-icon" onclick="GameApp.toggleMute()" id="mute-btn" title="toggle audio"><i class="fa-solid fa-volume-high"></i></button>
        <button class="modern-btn btn-start btn-icon" onclick="GameApp.startGame()" title="restart mission"><i class="fa-solid fa-rotate-right"></i></button>
        <button class="modern-btn btn-help btn-icon" onclick="GameApp.toggleInfo('help')" title="how to play"><i class="fa-solid fa-question"></i></button>
    </div>

    <div id="game-over-screen" class="screen interactive" role="region" aria-labelledby="go-title" aria-hidden="true">
        <div id="go-icon"></div>
        <h1 id="go-title">title</h1>
        <div id="go-reason"></div>
        <div id="go-score" class="subtitle">score: 0</div>

        <div class="btn-area">
            <div class="btn-group">
                <button class="modern-btn btn-danger full" onclick="GameApp.goHome()"><i class="fa-solid fa-house"></i> return to start</button>
            </div>
        </div>
    </div>

    <div id="edu-modal" class="modal-overlay interactive" aria-hidden="true">
        <div class="modal-box" role="dialog" aria-labelledby="edu-title">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h2 id="edu-title" style="display:flex;align-items:center;gap:10px;"><i class="fa-solid fa-brain" style="color:#ffd700;"></i> how is this educational?</h2>
                <button onclick="GameApp.toggleInfo('edu')" style="background:none;border:none;color:white;font-size:1.4rem;cursor:pointer;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-content">
                <p class="edu-short"><strong>short:</strong> you're a macrophage (white blood cell). eat pathogens quickly to protect the system. phagocytosis = engulfing + digesting.</p>
                <div class="edu-verbose">
                    <p><strong>subject: macrophage</strong></p>
                    <p>you are controlling a <em>macrophage</em> (greek for "big eater"). these are white blood cells that patrol your body.</p>
                    <p>when they find enemies (pathogens) or dead cells, they engulf and digest them in a process called <strong>phagocytosis</strong>. macrophages are essential first responders in the innate immune system.</p>
                    <p style="color:#ffaaaa;font-size:.95rem;"><em>biology note: in this simulation, you must quickly clear the infection before it overwhelms the system!</em></p>
                    <hr style="border:0;border-top:1px solid rgba(255,255,255,.06);margin:12px 0;">
                    <p><strong>controls:</strong></p>
                    <ul style="padding-left:20px;margin-top:6px;"><li>drag or tap to move the white cell.</li><li>absorb green pathogens to score (+10).</li><li>avoid red blood cells â€” they damage you (-20 health & -10 score).</li></ul>
                    <p style="margin-top:8px;"><strong>goal:</strong> collect 300 points in 30 seconds.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="help-modal" class="modal-overlay interactive" aria-hidden="true">
        <div class="modal-box" role="dialog" aria-labelledby="help-title">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h2 id="help-title">mission brief</h2>
                <button onclick="GameApp.toggleInfo('help')" style="background:none;border:none;color:white;font-size:1.4rem;cursor:pointer;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-content">
                <p><strong>controls:</strong></p>
                <p><i class="fa-solid fa-hand-pointer"></i> <strong>drag</strong> OR <strong>tap</strong> the screen to move.</p>
                <hr style="border:0;border-top:1px solid rgba(255,255,255,.06);margin:12px 0;">
                <p><strong>objectives:</strong></p>
                <ul style="padding-left:20px;"><li>absorb <strong style="color:#00ff00">green pathogens</strong> to score (+10).</li><li>avoid <strong style="color:#ff4444">red blood cells</strong> (-20 health & -10 score).</li></ul>
                <p><strong>goal:</strong> collect 300 points in <strong style="color:#ffd700">30 seconds</strong>.</p>
            </div>
        </div>
    </div>

</div>

<script>
    // parallax
    document.addEventListener('mousemove', (e) => {
        const screen = document.getElementById('start-screen');
        if(screen.classList.contains('active')){
            const title = document.getElementById('main-title');
            const x = (window.innerWidth / 2 - e.pageX) / 30;
            const y = (window.innerHeight / 2 - e.pageY) / 30;
            title.style.transform = `rotateY(${x}deg) rotateX(${y}deg)`;
        }
    });

    // audio engine
    const AudioEngine = {
        ctx:new (window.AudioContext || window.webkitAudioContext)(),
        muted:false,
        playTone(freq,type,duration,vol=0.1){
            if(this.muted || this.ctx.state === 'suspended') return;
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq,this.ctx.currentTime);
            gain.gain.setValueAtTime(vol,this.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01,this.ctx.currentTime+duration);
            osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(this.ctx.currentTime+duration);
        },
        playEat(){
            if(this.muted) return;
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
            osc.frequency.setValueAtTime(300,this.ctx.currentTime); osc.frequency.linearRampToValueAtTime(800,this.ctx.currentTime+0.1);
            gain.gain.setValueAtTime(0.1,this.ctx.currentTime); gain.gain.linearRampToValueAtTime(0,this.ctx.currentTime+0.1);
            osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(this.ctx.currentTime+0.1);
        },
        playHurt(){ this.playTone(100,'sawtooth',0.4,0.2); },
        playWin(){ if(this.muted) return; [440,554,659,880,1100].forEach((f,i)=>setTimeout(()=>this.playTone(f,'sine',0.2,0.1),i*100)); },
        toggleMute(){ this.muted = !this.muted; if(!this.muted && this.ctx.state === 'suspended') this.ctx.resume(); return this.muted; }
    };

    const GameApp = {
        gameInstance:null, isPlaying:false,
        startGame(){
            document.getElementById('start-screen').classList.remove('active');
            document.getElementById('game-over-screen').classList.remove('active');
            document.getElementById('game-hud').style.display='flex';
            document.getElementById('controls-area').style.display='flex';
            document.getElementById('edu-modal').style.display='none';
            document.getElementById('help-modal').style.display='none';
            document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
            this.isPlaying = true;
            if(this.gameInstance){
                const scene = this.gameInstance.scene.getScene('GameScene');
                if(scene) scene.scene.restart();
            }
            if(AudioEngine.ctx.state === 'suspended') AudioEngine.ctx.resume();
        },
        goHome(){
            this.isPlaying = false;
            document.getElementById('start-screen').classList.add('active');
            document.getElementById('game-hud').style.display='none';
            document.getElementById('controls-area').style.display='none';
            document.getElementById('game-over-screen').classList.remove('active');
            if(this.gameInstance){
                const scene = this.gameInstance.scene.getScene('GameScene');
                if(scene) scene.scene.pause();
            }
        },
        toggleInfo(type){
            const modalId = type === 'edu' ? 'edu-modal' : 'help-modal';
            const modal = document.getElementById(modalId);
            const otherId = type === 'edu' ? 'help-modal' : 'edu-modal';
            const other = document.getElementById(otherId);
            if(other){ other.style.display='none'; other.classList.remove('active'); other.setAttribute('aria-hidden','true'); }
            if(modal.style.display === 'flex'){ modal.style.display='none'; modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); }
            else{ modal.style.display='flex'; modal.classList.add('active'); modal.setAttribute('aria-hidden','false'); const content = modal.querySelector('.modal-content'); if(content) content.scrollTop = 0; }
        },
        toggleMute(){ const isMuted = AudioEngine.toggleMute(); const icon = document.querySelector('#mute-btn i'); icon.className = isMuted ? 'fa-solid fa-volume-xmark' : 'fa-solid fa-volume-high'; },
        updateHUD(score,target,health,time){ document.getElementById('score-val').innerText = score + " / " + target; document.getElementById('timer-val').innerText = time; document.getElementById('health-bar').style.width = health + '%'; document.getElementById('health-text').innerText = Math.floor(health) + '%'; if(score >= target) document.getElementById('score-val').style.color = '#00ff00'; else document.getElementById('score-val').style.color = 'white'; if(health < 30) document.getElementById('health-bar').style.background = '#ff0000'; else document.getElementById('health-bar').style.background = 'linear-gradient(90deg,#ff4444,#ff8800)'; },
        triggerGameOver(victory,score,reason){
            this.isPlaying = false;
            const screen = document.getElementById('game-over-screen');
            const title = document.getElementById('go-title');
            const icon = document.getElementById('go-icon');
            const reasonTxt = document.getElementById('go-reason');
            document.getElementById('game-hud').style.display='none';
            document.getElementById('controls-area').style.display='none';
            screen.classList.add('active');
            screen.setAttribute('aria-hidden','false');
            document.getElementById('go-score').innerText = 'final score: ' + score;
            reasonTxt.innerText = reason || "";
            if(victory){
                title.innerText = "quota met";
                title.style.background = "linear-gradient(to bottom,#00ff00,#88ff88)"; title.style.webkitBackgroundClip = "text"; title.style.webkitTextFillColor = "transparent";
                icon.innerHTML = '<i class="fa-solid fa-shield-virus" style="color:#00ff00"></i>'; AudioEngine.playWin();
            } else {
                title.innerText = "failure";
                title.style.background = "linear-gradient(to bottom,#ff0000,#ff4444)"; title.style.webkitBackgroundClip = "text"; title.style.webkitTextFillColor = "transparent";
                icon.innerHTML = '<i class="fa-solid fa-biohazard" style="color:#ff0000"></i>'; AudioEngine.playHurt();
            }
            setTimeout(()=>{ const sv = document.getElementById('game-over-screen'); if(sv && sv.scrollIntoView) sv.scrollIntoView({behavior:'smooth', block:'center'}); },80);
        }
    };

    class GameScene extends Phaser.Scene{
        constructor(){ super({ key:'GameScene' }); }
        preload(){
            let g = this.make.graphics({x:0,y:0,add:false});
            g.fillStyle(0xffffff,1); g.fillCircle(32,32,18); g.fillStyle(0xffffff,0.3); g.fillCircle(32,32,28); g.generateTexture('macrophage',64,64);
            g.clear(); g.fillStyle(0x00ff00,1); g.fillCircle(20,20,12); g.lineStyle(3,0x00ff00);
            for(let i=0;i<8;i++){ let a = Phaser.Math.DegToRad(i*45); g.lineBetween(20,20,20+Math.cos(a)*20,20+Math.sin(a)*20); }
            g.generateTexture('enemy',40,40);
            g.clear(); g.fillStyle(0xd63031,1); g.fillCircle(25,25,25); g.fillStyle(0xb71c1c,1); g.fillCircle(25,25,12); g.generateTexture('rbc',50,50);
            g.clear(); g.fillStyle(0xffffff,1); g.fillCircle(4,4,4); g.generateTexture('spark',8,8);
            g.clear(); g.fillStyle(0xff4444,0.6); g.fillCircle(4,4,4); g.generateTexture('plasma',8,8);
        }
        create(){
            this.targetScore = 300; this.timeLeft = 30; this.score = 0; this.health = 100; this.isGameOver = false;
            const isMobile = window.innerWidth < 850 || window.innerHeight < 500; this.scaleRatio = isMobile ? 0.6 : 1;
            this.bgEmitter = this.add.particles(0,0,'plasma',{ x: window.innerWidth+50, y:{min:0,max:window.innerHeight}, lifespan:3000, speedX:{min:-300,max:-600}, scale:{start:1,end:0.5}, quantity:1, blendMode:'ADD', frequency:200 });
            
            // Player positioning: Center of screen
            const startX = this.cameras.main.width / 2;
            const startY = this.cameras.main.height / 2;
            this.player = this.physics.add.sprite(startX, startY,'macrophage'); this.player.setCollideWorldBounds(true); this.player.setScale(this.scaleRatio);
            this.player.setInteractive({ cursor:'pointer' }); this.input.addPointer(1); this.input.setDraggable(this.player);
            this.player.lastX = this.player.x; this.player.lastY = this.player.y;
            this.player.targetX = null; this.player.targetY = null;

            this.tweens.add({ targets:this.player, scaleX:1.1*this.scaleRatio, scaleY:0.95*this.scaleRatio, yoyo:true, repeat:-1, duration:500 });
            
            // Drag Logic
            this.input.on('drag',(pointer,gameObject,dragX,dragY)=>{ 
                if(this.isGameOver || !GameApp.isPlaying) return; 
                gameObject.x = dragX; gameObject.y = dragY; 
                this.player.targetX = null; // Cancel tap move if dragging
            });

            // Tap Logic
            this.input.on('pointerdown', (pointer) => {
                if(this.isGameOver || !GameApp.isPlaying) return;
                // Only move if not dragging the player directly (simple distance check or just state)
                // Phaser handles drag first, so we set target only if it's a general click
                // But simplified: Just set target. If drag happens, it overrides x/y anyway.
                this.player.targetX = pointer.x;
                this.player.targetY = pointer.y;
            });

            this.enemies = this.physics.add.group(); this.friendlies = this.physics.add.group();
            this.emitter = this.add.particles(0,0,'spark',{ speed:{min:100,max:300}, scale:{start:1,end:0}, lifespan:400, blendMode:'ADD', emitting:false });
            this.time.addEvent({ delay:400, callback:this.spawnEnemy, callbackScope:this, loop:true });
            this.time.addEvent({ delay:1000, callback:this.spawnFriendly, callbackScope:this, loop:true });
            this.time.addEvent({ delay:1000, callback:this.tick, callbackScope:this, loop:true });
            this.physics.add.overlap(this.player,this.enemies,this.eatEnemy,null,this);
            this.physics.add.overlap(this.player,this.friendlies,this.hitFriendly,null,this);
            GameApp.updateHUD(0,this.targetScore,100,30);
            if(!GameApp.isPlaying) this.scene.pause();
        }
        update(){
            if(this.isGameOver || !GameApp.isPlaying) return;
            
            // Tap Movement Logic
            if (this.player.targetX !== null) {
                const distance = Phaser.Math.Distance.Between(this.player.x, this.player.y, this.player.targetX, this.player.targetY);
                if (distance < 10) {
                    this.player.body.setVelocity(0);
                    this.player.targetX = null;
                } else {
                    this.physics.moveTo(this.player, this.player.targetX, this.player.targetY, 400); // Speed 400
                }
            } else {
                 // Stop if no target (and not dragging, drag handles position directly)
                 if(this.player.body.velocity.length() > 0) this.player.body.setVelocity(0);
            }

            let dx = this.player.x - this.player.lastX; let dy = this.player.y - this.player.lastY;
            if(Math.abs(dx) > 1 || Math.abs(dy) > 1){ let angle = Math.atan2(dy,dx); this.player.rotation = Phaser.Math.Angle.RotateTo(this.player.rotation, angle, 0.2); }
            this.player.lastX = this.player.x; this.player.lastY = this.player.y;
            this.enemies.children.iterate(c => { if(c && c.x < -50) c.destroy(); });
            this.friendlies.children.iterate(c => { if(c && c.x < -50) c.destroy(); });
        }
        spawnEnemy(){ if(this.isGameOver || !GameApp.isPlaying) return; let y = Phaser.Math.Between(50, window.innerHeight-50); let e = this.enemies.create(window.innerWidth+50, y, 'enemy'); e.setScale(this.scaleRatio); e.setVelocityX(Phaser.Math.Between(-400,-700)); e.setAngularVelocity(150); }
        spawnFriendly(){ if(this.isGameOver || !GameApp.isPlaying) return; let y = Phaser.Math.Between(50, window.innerHeight-50); let f = this.friendlies.create(window.innerWidth+50, y, 'rbc'); f.setScale(this.scaleRatio); f.setVelocityX(Phaser.Math.Between(-300,-500)); }
        tick(){ if(this.isGameOver || !GameApp.isPlaying) return; this.timeLeft--; GameApp.updateHUD(this.score,this.targetScore,this.health,this.timeLeft); if(this.timeLeft <= 5) AudioEngine.playTone(800,'square',0.1); if(this.timeLeft <= 0){ if(this.score >= this.targetScore) this.endGame(true,"quota met!"); else this.endGame(false,"time out! not enough pathogens collected."); } }
        eatEnemy(player,enemy){ enemy.destroy(); AudioEngine.playEat(); this.emitter.emitParticleAt(enemy.x, enemy.y, 10); this.score += 10; this.health = Math.min(100, this.health + 5); GameApp.updateHUD(this.score,this.targetScore,this.health,this.timeLeft); }
        hitFriendly(player,friendly){ friendly.destroy(); AudioEngine.playHurt(); this.cameras.main.shake(200, 0.01); this.health -= 20; this.score = Math.max(0, this.score - 10); GameApp.updateHUD(this.score,this.targetScore,this.health,this.timeLeft); if(this.health <= 0) this.endGame(false,"cell integrity critical."); }
        endGame(victory,reason){ this.isGameOver = true; this.physics.pause(); GameApp.triggerGameOver(victory,this.score,reason); }
    }

    const config = {
        type: Phaser.AUTO,
        scale: { mode: Phaser.Scale.RESIZE, autoCenter: Phaser.Scale.CENTER_BOTH, width: window.innerWidth, height: window.innerHeight },
        parent: 'game-wrapper',
        transparent: true,
        physics: { default:'arcade', arcade: { gravity: { y:0 }, debug:false } },
        scene: [GameScene]
    };

    window.onload = () => { GameApp.gameInstance = new Phaser.Game(config); };

    window.addEventListener('orientationchange', () => {
        document.querySelectorAll('.modal-overlay').forEach(m => { m.style.display='none'; m.classList.remove('active'); m.setAttribute('aria-hidden','true'); });
    });
    window.addEventListener('resize', () => {
        if(GameApp && GameApp.updateHUD && GameApp.gameInstance){
            const scene = GameApp.gameInstance.scene.getScene('GameScene');
            if(scene) GameApp.updateHUD(scene.score || 0, scene.targetScore || 300, scene.health || 100, scene.timeLeft || 30);
        }
    });
</script>
</body>
</html>
