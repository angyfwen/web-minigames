<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Orbit Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --space-bg: #0b0b15;
            --neon-sun: #fbbf24;
            --neon-planet: #22d3ee;
            --neon-zone: #34d399;
            --neon-danger: #f43f5e;
            --font-head: 'Orbitron', sans-serif;
            --font-body: 'Share Tech Mono', monospace;
        }

        /* NUCLEAR MOBILE FIXES */
        * { -webkit-tap-highlight-color: transparent; touch-action: none; user-select: none; -webkit-user-select: none; }

        body {
            font-family: var(--font-body);
            background-color: var(--space-bg);
            color: #fff;
            width: 100vw; height: 100vh; height: 100dvh;
            margin: 0; padding: 0;
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            position: fixed; top:0; left:0; /* Lock screen */
            background: 
                radial-gradient(circle at 80% 20%, rgba(124, 58, 237, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 20% 80%, rgba(34, 211, 238, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, #11111f 0%, #000000 100%);
        }

        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #starfield { z-index: 0; opacity: 0.8; }
        #game-canvas { z-index: 1; }

        /* --- UI LAYER --- */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; 
            padding: 15px; box-sizing: border-box;
        }

        .hud-top { display: flex; justify-content: space-between; align-items: flex-start; pointer-events: auto; width: 100%; }

        .panel {
            background: rgba(10, 15, 30, 0.85); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 10px 15px;
            box-shadow: 0 4px 30px rgba(0,0,0,0.5); min-width: 140px;
        }

        .label { font-size: 0.6rem; color: #94a3b8; letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 4px; display: block; }
        .value-display { font-size: 1rem; font-weight: 700; color: var(--neon-planet); font-family: var(--font-head); }
        .data-row { font-size: 0.75rem; color: #cbd5e1; margin-top: 2px; display: flex; justify-content: space-between; gap: 10px; }
        .timer-val { font-family: var(--font-head); font-size: 1.5rem; color: white; line-height: 1; }
        .timer-val.active { color: var(--neon-zone); text-shadow: 0 0 15px rgba(52, 211, 153, 0.6); }

        .hud-bottom { display: flex; justify-content: space-between; align-items: flex-end; pointer-events: auto; padding-bottom: 5px; width: 100%; }
        
        .btn {
            border: 1px solid rgba(255,255,255,0.2); background: rgba(10, 15, 30, 0.8);
            width: 45px; height: 45px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.1rem; backdrop-filter: blur(4px);
            transition: 0.2s; cursor: pointer;
        }
        .btn:active { transform: scale(0.9); background: white; color: black; }
        
        .btn-reset { 
            width: auto; padding: 0 20px; height: 45px; 
            border-color: var(--neon-danger); color: var(--neon-danger); 
            font-family: var(--font-head); font-size: 0.9rem;
        }
        .btn-reset:active { background: var(--neon-danger); color: white; }

        /* --- START SCREEN --- */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
        }

        .holo-container {
            background: rgba(8, 12, 25, 0.85); border: 1px solid var(--neon-planet);
            box-shadow: 0 0 50px rgba(34, 211, 238, 0.2);
            padding: 30px; border-radius: 20px; text-align: center;
            position: relative; animation: floatUI 6s ease-in-out infinite; width: 90%; max-width: 350px;
        }
        @keyframes floatUI { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-8px);} }

        .title-main {
            font-family: var(--font-head); font-size: 2.5rem; line-height: 1; margin-bottom: 8px;
            background: linear-gradient(to bottom, #fff, #67e8f9); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(34, 211, 238, 0.4);
        }
        .btn-start {
            background: rgba(34, 211, 238, 0.15); color: var(--neon-planet); font-size: 1.2rem; padding: 15px 0; width: 100%;
            border: 1px solid var(--neon-planet); border-radius: 8px; font-family: var(--font-head); margin-top: 20px;
        }
        .btn-start:active { background: var(--neon-planet); color: #000; }

        /* --- MODALS --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-box {
            background: #0b0b15; border: 1px solid var(--neon-zone); padding: 30px 20px; width: 85%; max-width: 360px; text-align: center;
            box-shadow: 0 0 60px rgba(52, 211, 153, 0.2); border-radius: 16px;
        }
        .modal-h { font-family: var(--font-head); font-size: 1.8rem; margin-bottom: 10px; color: white; }
        .modal-p { font-size: 0.95rem; color: #94a3b8; margin-bottom: 20px; line-height: 1.4; }
        
        .info-item { margin-bottom: 15px; display: flex; gap: 12px; align-items: flex-start; text-align: left; }
        .info-icon { font-size: 1.4rem; color: var(--neon-planet); min-width: 25px; margin-top: 2px; }
        .info-title { color: var(--neon-sun); font-family: var(--font-head); font-weight: 700; font-size: 1rem; }
        .info-desc { color: #cbd5e1; font-size: 0.85rem; }

    </style>
</head>
<body>

    <canvas id="starfield"></canvas>
    <canvas id="game-canvas"></canvas>

    <div class="ui-layer" id="game-ui" style="display:none;">
        <div class="hud-top">
            <div class="panel">
                <div class="label">TELEMETRY</div>
                <div class="value-display" id="level-display">SECTOR 01</div>
                <div class="data-row">
                    <span>SPD</span> <span><span class="data-num" id="val-speed">0</span> km/s</span>
                </div>
            </div>
            
            <div class="panel" style="text-align: right;">
                <div class="label">ORBIT TIME</div>
                <div class="timer-val" id="orbit-timer">0.0s</div>
                <div class="text-xs text-gray-400 font-bold" id="target-time">GOAL: 15s</div>
            </div>
        </div>

        <div class="hud-bottom">
            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="goHome()"><i class="fa-solid fa-house"></i></button>
                <button class="btn" onclick="showHelp()"><i class="fa-solid fa-question"></i></button>
            </div>
            <button class="btn btn-reset" onclick="resetLevel()">
                <i class="fa-solid fa-rotate-right mr-2"></i> RETRY
            </button>
        </div>
    </div>

    <div id="start-screen">
        <div class="holo-container">
            <div style="font-size: 3rem; color: var(--neon-sun); margin-bottom: 10px; filter: drop-shadow(0 0 20px var(--neon-sun));">
                <i class="fa-solid fa-atom fa-spin" style="--fa-animation-duration: 20s;"></i>
            </div>
            <div class="title-main">ORBIT<br>ARCHITECT</div>
            <div style="color: #94a3b8; font-size: 0.8rem; letter-spacing: 4px; margin-bottom: 20px;">MOBILE EDITION</div>
            
            <button class="btn-start" onclick="startGame()">INITIALIZE</button>
            
            <button style="margin-top:15px; background:none; border:none; color:#64748b; font-family:var(--font-head); font-size:0.8rem; letter-spacing:1px;" onclick="showEducationalInfo()">
                EDUCATIONAL VALUE
            </button>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-box" style="border-color: var(--neon-zone);">
            <div class="text-5xl text-emerald-400 mb-4"><i class="fa-regular fa-circle-check"></i></div>
            <div class="modal-h">STABLE ORBIT</div>
            <p class="modal-p">Trajectory maintained for 15 seconds. Excellent work, Architect.</p>
            <button class="btn-start" style="margin-top:0; border-color:var(--neon-zone); background:rgba(52, 211, 153, 0.1); color:var(--neon-zone);" onclick="nextLevel()">NEXT SECTOR</button>
        </div>
    </div>

    <div id="finish-modal" class="modal">
        <div class="modal-box" style="border-color: var(--neon-sun);">
            <div class="text-5xl text-yellow-400 mb-4"><i class="fa-solid fa-trophy"></i></div>
            <div class="modal-h" style="color: var(--neon-sun);">COMPLETE</div>
            <p class="modal-p">All sectors mapped successfully.</p>
            <button class="btn-start" style="margin-top:0; border-color:white; color:white;" onclick="goHome()">HOME</button>
        </div>
    </div>

    <div id="crash-modal" class="modal">
        <div class="modal-box" style="border-color: var(--neon-danger);">
            <div class="text-5xl text-red-500 mb-4"><i class="fa-solid fa-triangle-exclamation"></i></div>
            <div class="modal-h" style="color: var(--neon-danger);">FAILURE</div>
            <p class="modal-p" id="crash-msg">Object collision detected.</p>
            <button class="btn-start" style="margin-top:0; border-color:var(--neon-danger); background:rgba(244, 63, 94, 0.1); color:var(--neon-danger);" onclick="resetLevel()">RETRY LAUNCH</button>
        </div>
    </div>

    <div id="help-modal" class="modal">
        <div class="modal-box" style="text-align: left; border-color: var(--neon-planet);">
            <div class="modal-h" style="text-align: center; color: var(--neon-planet);">FLIGHT MANUAL</div>
            
            <div class="info-item">
                <i class="fa-solid fa-hand-pointer info-icon"></i>
                <div>
                    <div class="info-title">Drag & Aim</div>
                    <div class="info-desc">Touch the blue planet and pull back like a slingshot to launch.</div>
                </div>
            </div>
            <div class="info-item">
                <i class="fa-solid fa-circle-notch info-icon"></i>
                <div>
                    <div class="info-title">Green Zone</div>
                    <div class="info-desc">Launch the planet into the glowing green ring.</div>
                </div>
            </div>
            <div class="info-item">
                <i class="fa-solid fa-stopwatch info-icon"></i>
                <div>
                    <div class="info-title">Stay Stable</div>
                    <div class="info-desc">Keep it inside the ring for 15 seconds to win.</div>
                </div>
            </div>
            <button class="btn-start" style="margin-top:10px; border-color:white; color:white;" onclick="closeHelp()">ACKNOWLEDGE</button>
        </div>
    </div>

    <div id="edu-modal" class="modal">
        <div class="modal-box" style="text-align: left;">
            <div class="modal-h" style="text-align:center; font-size:1.5rem;"><i class="fa-solid fa-brain"></i> PHYSICS ENGINE</div>
            <div class="info-item">
                <i class="fa-solid fa-atom info-icon"></i>
                <div>
                    <div class="info-title">Gravity</div>
                    <div class="info-desc">Objects with mass attract each other. The Sun pulls the planet inward.</div>
                </div>
            </div>
            <div class="info-item">
                <i class="fa-solid fa-rocket info-icon"></i>
                <div>
                    <div class="info-title">Velocity</div>
                    <div class="info-desc">Speed fights gravity. If you go too fast, you fly away. Too slow, you crash.</div>
                </div>
            </div>
            <div class="info-item">
                <i class="fa-solid fa-circle-nodes info-icon"></i>
                <div>
                    <div class="info-title">Orbit</div>
                    <div class="info-desc">An orbit is a perfect balance where you are falling towards the sun but missing it constantly!</div>
                </div>
            </div>
            <button class="btn-start" style="margin-top:10px;" onclick="closeEduInfo()">CLOSE</button>
        </div>
    </div>

    <script>
        const AudioSys = {
            ctx: null, muted: false,
            init() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            playTone(type, freq, dur, vol=0.1) {
                if(this.muted || !this.ctx) return; const o=this.ctx.createOscillator(), g=this.ctx.createGain();
                o.type=type; o.frequency.value=freq; g.gain.setValueAtTime(vol, this.ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime+dur);
                o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+dur);
            },
            launch() { this.init(); this.playTone('sawtooth', 150, 0.4, 0.05); },
            win() { this.init(); this.playTone('sine', 440, 0.1, 0.1); setTimeout(()=>this.playTone('sine', 880, 0.3, 0.1), 100); },
            crash() { this.init(); this.playTone('sawtooth', 80, 0.5, 0.1); }
        };

        function toggleMute() { AudioSys.muted = !AudioSys.muted; }

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const starCanvas = document.getElementById('starfield');
        const starCtx = starCanvas.getContext('2d');
        
        let width, height, minDim; // minDim helps scaling
        let stars = [];

        function resize() { 
            width = canvas.width = starCanvas.width = window.innerWidth; 
            height = canvas.height = starCanvas.height = window.innerHeight;
            minDim = Math.min(width, height);
            
            // CENTER EVERYTHING
            sun.x = width / 2;
            sun.y = height / 2;
            
            initStars();
            // If dragging, reset drag to avoid glitches
            if(isDragging) isDragging = false; 
        }
        window.addEventListener('resize', resize); 

        function initStars() {
            stars = [];
            for(let i=0; i<150; i++) {
                stars.push({
                    x: Math.random() * width, y: Math.random() * height,
                    size: Math.random() * 1.5, opacity: Math.random(),
                    speed: Math.random() * 0.05 + 0.01
                });
            }
        }

        function drawStars() {
            starCtx.clearRect(0, 0, width, height);
            stars.forEach(star => {
                star.y -= star.speed; 
                if(star.y < 0) star.y = height; 
                if(Math.random() > 0.995) star.opacity = Math.random();
                starCtx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                starCtx.beginPath(); starCtx.arc(star.x, star.y, star.size, 0, Math.PI*2); starCtx.fill();
            });
            requestAnimationFrame(drawStars);
        }

        /* --- PHYSICS & GAME STATE --- */
        // Adjusted G for mobile viewports
        const G = 0.5; 
        const LAUNCH_POWER = 0.08; 
        
        let currentLevel = 0;
        let isDragging = false;
        let dragCurrent = {x:0, y:0};
        
        // Dynamic Objects (Radii are relative to minDim)
        let sun = { x: 0, y: 0, mass: 2000, radius: 25 };
        let planet = { x: 0, y: 0, vx: 0, vy: 0, radius: 12, active: false, trail: [] };
        
        // Zone is now a ratio (0.0 - 1.0) of minDim
        let targetZone = { minR: 0.3, maxR: 0.45 }; 
        
        let stableTime = 0;
        let totalFlightTime = 0;
        let requiredTime = 15.0; 
        let gameState = 'AIMING'; 

        // Ratios relative to screen width/height (minDim)
        const LEVELS = [
            { id: 1, massMulti: 1.0, zone: [0.25, 0.40] }, 
            { id: 2, massMulti: 1.3, zone: [0.30, 0.45] }, 
            { id: 3, massMulti: 1.5, zone: [0.20, 0.30] }, 
            { id: 4, massMulti: 1.8, zone: [0.35, 0.45] }, 
            { id: 5, massMulti: 2.0, zone: [0.22, 0.32] } 
        ];

        function initLevel() {
            const lvl = LEVELS[currentLevel];
            
            // Adjust physics based on screen size
            sun.radius = minDim * 0.08; // Sun is 8% of screen
            planet.radius = minDim * 0.03; // Planet is 3%
            
            // Adjust mass so gravity feels consistent on small vs big screens
            // F ~ M/r^2. If r scales by S, F scales by 1/S^2. To keep F ~ 1/S (relative), M must scale by S.
            sun.mass = 2500 * lvl.massMulti * (minDim / 400); 

            planet.active = false;
            
            // Safe spawn distance (scale based)
            const angle = Math.random() * Math.PI * 2;
            const spawnDist = minDim * 0.18; // Close enough to drag, far enough from sun
            
            planet.x = sun.x + Math.cos(angle) * spawnDist;
            planet.y = sun.y + Math.sin(angle) * spawnDist;
            
            planet.vx = 0; planet.vy = 0;
            planet.trail = [];

            targetZone.minR = lvl.zone[0] * minDim;
            targetZone.maxR = lvl.zone[1] * minDim;
            
            stableTime = 0;
            totalFlightTime = 0;
            gameState = 'AIMING';

            document.getElementById('level-display').innerText = `SECTOR ${lvl.id}`;
            document.getElementById('val-speed').innerText = "0";
            updateTimerDisplay();
            hideModals();
        }

        function hideModals() {
            document.querySelectorAll('.modal').forEach(el => el.style.display = 'none');
        }

        function update() {
            if (gameState === 'FLYING') {
                const dx = sun.x - planet.x;
                const dy = sun.y - planet.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                const force = G * sun.mass / (dist*dist);
                const ax = force * (dx / dist);
                const ay = force * (dy / dist);

                planet.vx += ax;
                planet.vy += ay;
                planet.x += planet.vx;
                planet.y += planet.vy;

                if (planet.trail.length > 100) planet.trail.shift();
                planet.trail.push({x: planet.x, y: planet.y});

                const speed = Math.sqrt(planet.vx*planet.vx + planet.vy*planet.vy) * 10;
                document.getElementById('val-speed').innerText = Math.round(speed);

                // Collision Logic
                if (dist < sun.radius + planet.radius) failLevel("IMPACT WITH STAR");
                if (dist > minDim * 1.5) failLevel("SIGNAL LOST"); // Flew off screen

                // Zone Logic
                if (dist >= targetZone.minR && dist <= targetZone.maxR) {
                    stableTime += 1/60;
                    if(stableTime >= requiredTime) {
                        gameState = 'WIN'; AudioSys.win();
                        if(currentLevel === LEVELS.length - 1) document.getElementById('finish-modal').style.display = 'flex';
                        else document.getElementById('modal').style.display = 'flex';
                    }
                } else {
                    // Reset stable time if you leave zone? (Optional difficulty tweak: currently doesn't reset, just pauses)
                    // Uncomment to make harder: stableTime = 0; 
                }
                
                // Max flight time to prevent infinite loops
                totalFlightTime += 1/60;
                if(totalFlightTime > 45) failLevel("FUEL DEPLETED");

                updateTimerDisplay(dist >= targetZone.minR && dist <= targetZone.maxR);
            }
        }

        function failLevel(msg) {
            gameState = 'CRASH'; AudioSys.crash();
            document.getElementById('crash-msg').innerText = msg;
            document.getElementById('crash-modal').style.display = 'flex';
        }

        function draw() {
            ctx.clearRect(0, 0, width, height);

            // Zone
            ctx.beginPath();
            ctx.arc(sun.x, sun.y, targetZone.maxR, 0, Math.PI * 2);
            ctx.arc(sun.x, sun.y, targetZone.minR, 0, Math.PI * 2, true);
            ctx.fillStyle = 'rgba(52, 211, 153, 0.1)'; 
            ctx.fill();
            ctx.strokeStyle = 'rgba(52, 211, 153, 0.3)'; ctx.lineWidth = 2; ctx.stroke();

            // Sun
            let sunGrad = ctx.createRadialGradient(sun.x, sun.y, sun.radius*0.2, sun.x, sun.y, sun.radius);
            sunGrad.addColorStop(0, '#fff'); sunGrad.addColorStop(0.3, '#fbbf24'); sunGrad.addColorStop(1, '#b45309'); 
            ctx.beginPath(); ctx.arc(sun.x, sun.y, sun.radius, 0, Math.PI * 2);
            ctx.fillStyle = sunGrad; ctx.shadowBlur = 30; ctx.shadowColor = '#fbbf24'; ctx.fill(); ctx.shadowBlur = 0;

            // Planet
            let pGrad = ctx.createRadialGradient(planet.x - planet.radius*0.3, planet.y - planet.radius*0.3, planet.radius*0.2, planet.x, planet.y, planet.radius);
            pGrad.addColorStop(0, '#a5f3fc'); pGrad.addColorStop(1, '#0891b2'); 
            ctx.beginPath(); ctx.arc(planet.x, planet.y, planet.radius, 0, Math.PI * 2);
            ctx.fillStyle = pGrad; ctx.fill();

            // Visual "Drag Ring" around planet when aiming (Mobile UX)
            if(gameState === 'AIMING') {
                ctx.beginPath();
                ctx.arc(planet.x, planet.y, planet.radius + 15, 0, Math.PI * 2);
                ctx.strokeStyle = 'rgba(255,255,255,0.5)';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // Trail
            if (planet.trail.length > 1) {
                ctx.beginPath(); ctx.moveTo(planet.trail[0].x, planet.trail[0].y);
                for (let p of planet.trail) ctx.lineTo(p.x, p.y);
                ctx.strokeStyle = 'rgba(34, 211, 238, 0.4)'; ctx.lineWidth = 2; ctx.stroke();
            }

            // Aiming Vector
            if (gameState === 'AIMING' && isDragging) {
                ctx.beginPath(); ctx.moveTo(planet.x, planet.y); ctx.lineTo(dragCurrent.x, dragCurrent.y);
                ctx.strokeStyle = '#f43f5e'; ctx.lineWidth = 3; ctx.stroke();
                
                // Trajectory Prediction (Small dot)
                let simX = planet.x; let simY = planet.y;
                let simVx = (planet.x - dragCurrent.x) * LAUNCH_POWER;
                let simVy = (planet.y - dragCurrent.y) * LAUNCH_POWER;
                
                ctx.beginPath();
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                for(let i=0; i<10; i++) {
                    simX += simVx * 5; simY += simVy * 5; // Rough prediction
                    ctx.fillRect(simX, simY, 2, 2);
                }
            }

            requestAnimationFrame(() => { update(); draw(); });
        }

        // TOUCH HANDLING
        function getPos(e) {
            const r = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - r.left, y: clientY - r.top };
        }

        canvas.addEventListener('mousedown', startDrag);
        canvas.addEventListener('touchstart', startDrag, {passive: false});

        function startDrag(e) {
            if (gameState !== 'AIMING') return;
            const pos = getPos(e);
            // Generous hit detection for mobile (radius + 40px padding)
            if (Math.hypot(pos.x - planet.x, pos.y - planet.y) < planet.radius + 40) { 
                isDragging = true; dragCurrent = pos;
                if(e.type === 'touchstart') e.preventDefault(); // Stop scroll
            }
        }

        window.addEventListener('mousemove', e => { if (isDragging) dragCurrent = getPos(e); });
        window.addEventListener('touchmove', e => { if (isDragging) { e.preventDefault(); dragCurrent = getPos(e); } }, {passive: false});

        window.addEventListener('mouseup', endDrag);
        window.addEventListener('touchend', endDrag);

        function endDrag() {
            if (!isDragging) return;
            isDragging = false;
            const vx = (planet.x - dragCurrent.x) * LAUNCH_POWER;
            const vy = (planet.y - dragCurrent.y) * LAUNCH_POWER;
            
            // Prevent accidental tiny taps
            if (Math.hypot(vx, vy) > 0.5) { 
                planet.vx = vx; planet.vy = vy; gameState = 'FLYING'; AudioSys.launch(); 
            }
        }

        function updateTimerDisplay(isActive) {
            const el = document.getElementById('orbit-timer');
            el.innerText = stableTime.toFixed(1) + 's';
            if (isActive) el.classList.add('active'); else el.classList.remove('active');
        }

        function startGame() { AudioSys.init(); document.getElementById('start-screen').style.display = 'none'; document.getElementById('game-ui').style.display = 'flex'; currentLevel = 0; resize(); initLevel(); draw(); drawStars(); }
        function goHome() { location.reload(); }
        function resetLevel() { initLevel(); }
        function nextLevel() { currentLevel++; if(currentLevel >= LEVELS.length) { document.getElementById('finish-modal').style.display = 'flex'; } else { initLevel(); } }
        
        function showEducationalInfo() { document.getElementById('edu-modal').style.display = 'flex'; }
        function closeEduInfo() { document.getElementById('edu-modal').style.display = 'none'; }
        function showHelp() { document.getElementById('help-modal').style.display = 'flex'; }
        function closeHelp() { document.getElementById('help-modal').style.display = 'none'; }

        // Boot
        resize();
        initStars();
        drawStars();

    </script>
</body>
</html>
